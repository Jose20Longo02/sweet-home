function initializeProjectDetail(){initializeGallery(),initializeContactForm(),relocateProjectContactOnMobile(),initializeSmoothScrolling(),initializeRelatedProjects(),trackProjectView()}function initializeGallery(){const e=document.getElementById("main-image")||document.getElementById("mainVideo"),t=document.querySelectorAll(".thumbnail"),n=document.querySelector(".gallery-nav.prev"),o=document.querySelector(".gallery-nav.next");e&&0!==t.length&&(setupVideoOverlayAndPoster(),t.forEach(e=>{e.addEventListener("click",function(){const e=this.dataset.type||"image",t=this.dataset.index;if("video"===e)showMainVideo(this.dataset.videoUrl);else{updateMainImage(this.dataset.photo,t)}updateActiveThumbnail(t)})}),document.addEventListener("keydown",function(e){"ArrowLeft"===e.key?navigateGallery("prev"):"ArrowRight"===e.key&&navigateGallery("next")}),n&&n.addEventListener("click",()=>navigateGallery("prev")),o&&o.addEventListener("click",()=>navigateGallery("next")),initializeTouchSupport())}function updateMainImage(e,t){const n=document.querySelector(".gallery-main");if(!n)return;const o=document.getElementById("main-image")||document.getElementById("mainVideo");o&&(o.style.opacity="0"),setTimeout(()=>{const t=n.querySelector("picture"),o=n.querySelector("#main-image"),r=n.querySelector("#mainVideo"),a=n.querySelector(".video-play-overlay");t&&t.remove(),o&&o.remove(),r&&r.remove(),a&&a.remove();const i=document.createElement("img");i.id="main-image",i.className="main-image",i.alt=document.querySelector(".project-title")?document.querySelector(".project-title").textContent:"Project photo",i.decoding="async",i.src=e,i.onerror=function(){this.onerror=null,this.src="/img/property-placeholder.jpg",this.style.opacity="0.5"},n.insertBefore(i,n.firstChild),requestAnimationFrame(()=>{i.style.opacity="1"})},150)}function showMainVideo(e){const t=document.querySelector(".gallery-main");if(!t)return;const n=document.getElementById("main-image")||document.getElementById("mainVideo");n&&(n.style.opacity="0"),setTimeout(()=>{const n=t.querySelector("picture"),o=t.querySelector("#main-image"),r=t.querySelector("#mainVideo"),a=t.querySelector(".video-play-overlay");n&&n.remove(),o&&o.remove(),r&&r.remove(),a&&a.remove();const i=document.createElement("video");i.id="mainVideo",i.controls=!0,i.playsInline=!0,i.preload="metadata",i.style.width="100%",i.style.height="100%",i.style.objectFit="contain";const c=document.createElement("source");c.src=e,c.type="video/mp4",i.appendChild(c),t.insertBefore(i,t.firstChild);const s=document.createElement("button");s.className="video-play-overlay",s.type="button",s.setAttribute("aria-label","Play video"),s.innerHTML='<svg viewBox="0 0 64 64" width="64" height="64" aria-hidden="true"><circle cx="32" cy="32" r="31" fill="rgba(0,0,0,0.6)" stroke="white" stroke-width="2" /><polygon points="26,20 26,44 46,32" fill="white" /></svg>',t.appendChild(s),s.addEventListener("click",function(){try{i.play()}catch(e){}s.style.display="none"}),i.addEventListener("play",function(){s.style.display="none"}),i.addEventListener("pause",function(){s.style.display="flex",s.dataset.shownAt=String(Date.now())}),s.style.display="flex",tryGeneratePoster(i,1),requestAnimationFrame(()=>{i.style.opacity="1"})},150)}function setupVideoOverlayAndPoster(){const e=document.getElementById("mainVideo"),t=document.querySelector(".video-play-overlay");e&&t&&(t.addEventListener("click",function(){try{e.play()}catch(e){}t.style.display="none"}),e.addEventListener("play",function(){t.style.display="none"}),e.addEventListener("pause",function(){t.style.display="flex",t.dataset.shownAt=String(Date.now())}),tryGeneratePoster(e,1),e.paused&&(t.style.display="flex"))}function tryGeneratePoster(e,t){if(!e)return;const n=()=>{const n=Math.min(t||1,Math.max(.1,(e.duration||1)-.1)),o=()=>{const t=document.createElement("canvas");t.width=e.videoWidth||1280,t.height=e.videoHeight||720;const n=t.getContext("2d");try{n.drawImage(e,0,0,t.width,t.height);const o=t.toDataURL("image/jpeg",.85);o&&o.length>50&&e.setAttribute("poster",o)}catch(e){}},r=()=>{o();try{e.currentTime=0}catch(e){}e.removeEventListener("seeked",r)};e.addEventListener("seeked",r);try{e.currentTime=n}catch(t){o(),e.removeEventListener("seeked",r)}};if(!isNaN(e.duration)&&e.videoWidth>0)n();else{e.addEventListener("loadedmetadata",n,{once:!0});try{e.preload="metadata"}catch(e){}}}function trackProjectView(){const e=document.querySelector(".project-sidebar");if(!e)return;const t=e.getAttribute("data-project-id");if(!t)return;const n=document.querySelector('meta[name="csrf-token"]'),o=n?n.getAttribute("content"):"";fetch(`/projects/api/${encodeURIComponent(t)}/view`,{method:"POST",headers:{"CSRF-Token":o}}).catch(()=>{})}function updateActiveThumbnail(e){document.querySelectorAll(".thumbnail").forEach(e=>{e.classList.remove("active")});const t=document.querySelector(`[data-index="${e}"]`);t&&t.classList.add("active")}function navigateGallery(e){const t=document.querySelectorAll(".thumbnail"),n=document.querySelector(".thumbnail.active");if(!n||t.length<=1)return;let o,r=parseInt(n.dataset.index);o="prev"===e?r>0?r-1:t.length-1:r<t.length-1?r+1:0;const a=document.querySelector(`[data-index="${o}"]`);a&&a.click()}function initializeTouchSupport(){const e=document.querySelector(".gallery-main");if(!e)return;let t=0,n=0,o=0,r=0;e.addEventListener("touchstart",function(e){t=e.touches[0].clientX,n=e.touches[0].clientY}),e.addEventListener("touchend",function(e){o=e.changedTouches[0].clientX,r=e.changedTouches[0].clientY,function(){const e=t-o,a=n-r;Math.abs(e)>Math.abs(a)&&Math.abs(e)>50&&navigateGallery(e>0?"next":"prev")}()})}function initializeContactForm(){const e=document.getElementById("project-contact-form");e&&(e.addEventListener("submit",async function(e){if(e.preventDefault(),validateContactForm()){try{var t=document.getElementById("recaptchaTokenProject");if(t&&!t.value&&window.grecaptcha&&"function"==typeof grecaptcha.execute){var n=t.getAttribute("data-site-key");n&&await new Promise(e=>{"function"==typeof grecaptcha.ready?grecaptcha.ready(function(){grecaptcha.execute(n,{action:"property_lead"}).then(function(n){t.value=n||"",e()}).catch(function(){e()})}):e()})}}catch(e){}submitContactForm()}}),addFormValidation())}function validateContactForm(){const e=document.getElementById("contact-name").value.trim(),t=document.getElementById("contact-email").value.trim(),n=document.getElementById("contact-phone").value.trim(),o=document.getElementById("contact-cc").value.trim(),r=document.getElementById("contact-message").value.trim();clearFormErrors();let a=!0;return e||(showFieldError("contact-name","Name is required"),a=!1),t?isValidEmail(t)||(showFieldError("contact-email","Please enter a valid email address"),a=!1):(showFieldError("contact-email","Email is required"),a=!1),o||(showFieldError("contact-cc","Country code is required"),a=!1),n||(showFieldError("contact-phone","Phone number is required"),a=!1),r||(showFieldError("contact-message","Message is required"),a=!1),a}function isValidEmail(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}function showFieldError(e,t){const n=document.getElementById(e);if(!n)return;n.classList.add("error");let o=n.parentNode.querySelector(".error-message");o||(o=document.createElement("div"),o.className="error-message",n.parentNode.appendChild(o)),o.textContent=t,o.style.display="block"}function clearFormErrors(){const e=document.querySelectorAll(".form-input.error, .form-textarea.error"),t=document.querySelectorAll(".error-message");e.forEach(e=>{e.classList.remove("error")}),t.forEach(e=>{e.style.display="none"})}function addFormValidation(){document.querySelectorAll("#project-contact-form input, #project-contact-form textarea").forEach(e=>{e.addEventListener("blur",function(){validateField(this)}),e.addEventListener("input",function(){if(this.classList.contains("error")){this.classList.remove("error");const e=this.parentNode.querySelector(".error-message");e&&(e.style.display="none")}})})}function validateField(e){const t=e.value.trim();return e.hasAttribute("required")&&!t?(showFieldError(e.id,`${e.previousElementSibling.textContent} is required`),!1):!("email"===e.type&&t&&!isValidEmail(t))||(showFieldError(e.id,"Please enter a valid email address"),!1)}async function submitContactForm(){const e=document.getElementById("project-contact-form"),t=e.querySelector('button[type="submit"]'),n=t.innerHTML;t.innerHTML='<i class="fas fa-spinner fa-spin"></i> Sending...',t.disabled=!0;const o=new FormData(e),r=Object.fromEntries(o.entries());if(!r.recaptchaToken){const e=document.getElementById("recaptchaTokenProject");e&&e.value&&(r.recaptchaToken=e.value)}if(!r.recaptchaToken&&window.grecaptcha&&"function"==typeof grecaptcha.execute){console.log("Attempting to generate reCAPTCHA token on form submission...");try{const e=document.querySelector('script[src*="recaptcha/api.js"]'),t=e?e.src.match(/render=([^&]+)/)?.[1]:null;if(t){const e=await grecaptcha.execute(t,{action:"property_lead"});r.recaptchaToken=e,console.log("Generated token on submission:",e?e.substring(0,10)+"...":"null")}}catch(e){console.error("Failed to generate token on submission:",e)}}if(console.log("Project form submission - reCAPTCHA token present:",!!r.recaptchaToken),r.recaptchaToken)console.log("Project form submission - reCAPTCHA token preview:",r.recaptchaToken.substring(0,10)+"...");else{console.log("Project form submission - NO reCAPTCHA token found!");const e=document.getElementById("recaptchaTokenProject");console.log("Token element exists:",!!e),e&&console.log("Token element value:",e.value?e.value.substring(0,10)+"...":"empty")}r.projectId||(r.projectId=getProjectId());const a=e.querySelector("#contact-language");a&&!r.language&&(r.language=a.value||""),(r.countryCode||r.phone)&&(r.phone=`${r.countryCode||""} ${r.phone||""}`.trim()),fetch("/api/leads/project",{method:"POST",headers:{"Content-Type":"application/json","CSRF-Token":document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")||"","x-csrf-token":document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")||""},body:JSON.stringify(r)}).then(e=>e.json()).then(t=>{if(t.success){if(window.analytics&&window.analytics.trackFormSubmit){const e=r.projectId||getProjectId();window.analytics.trackFormSubmit("project_contact",null,e)}showSuccessMessage("Thank you! Your message has been sent successfully."),e.reset()}else console.error("Project form submission error:",t),showErrorMessage(t.message||"Error sending message. Please try again.")}).catch(e=>{console.error("Error:",e),showErrorMessage("Error sending message. Please try again.")}).finally(()=>{t.innerHTML=n,t.disabled=!1})}function showSuccessMessage(e){showMessage(e,"success")}function showErrorMessage(e){showMessage(e,"error")}function showMessage(e,t){const n=document.createElement("div");n.className=`message message-${t}`,n.textContent=e,document.body.appendChild(n),requestAnimationFrame(()=>{n.classList.add("show")}),setTimeout(()=>{n.classList.remove("show"),setTimeout(()=>{n.parentNode&&n.parentNode.removeChild(n)},300)},3e3)}function initializeSmoothScrolling(){document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();const t=this.getAttribute("href"),n=document.querySelector(t);n&&n.scrollIntoView({behavior:"smooth",block:"start"})})})}function initializeRelatedProjects(){document.querySelectorAll(".related-project-item").forEach(e=>{e.addEventListener("mouseenter",function(){this.style.transform="translateX(4px)"}),e.addEventListener("mouseleave",function(){this.style.transform="translateX(0)"})})}function relocateProjectContactOnMobile(){const e=document.querySelector(".project-sidebar");if(!e)return;const t=document.querySelector(".project-layout");if(!t)return;const n=()=>{if(window.matchMedia("(max-width: 1024px)").matches){const n=document.querySelector("footer");n&&e.parentNode===t&&n.parentNode.insertBefore(e,n)}else if(e.parentNode!==t){const n=document.querySelector("footer");if(n&&e.parentNode===n.parentNode){const n=document.querySelector(".project-main");n&&n.parentNode===t&&t.appendChild(e)}}};window.matchMedia("(max-width: 1024px)").matches&&requestAnimationFrame(()=>{requestAnimationFrame(n)}),window.addEventListener("resize",n)}function getProjectId(){const e=document.querySelector("[data-project-id]");if(e)return e.dataset.projectId;const t=window.location.pathname.split("/");return t[t.length-1]}function getProjectTitle(){const e=document.querySelector(".project-title");return e?e.textContent:"Project"}function addErrorStyles(){if(document.getElementById("error-styles"))return;const e=document.createElement("style");e.id="error-styles",e.textContent="\n    .form-input.error,\n    .form-textarea.error {\n      border-color: var(--red-500) !important;\n      box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;\n    }\n    \n    .error-message {\n      color: var(--red-600);\n      font-size: var(--font-size-sm);\n      margin-top: var(--spacing-1);\n      display: none;\n    }\n    \n    .form-input:focus.error,\n    .form-textarea:focus.error {\n      box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;\n    }\n\n    /* Toast message like property page */\n    .message {\n      position: fixed;\n      top: 20px;\n      right: 20px;\n      padding: 1rem 1.5rem;\n      border-radius: 8px;\n      color: #fff;\n      font-weight: 600;\n      z-index: 2000;\n      transform: translateX(100%);\n      transition: transform .3s ease;\n      box-shadow: 0 10px 30px rgba(0,0,0,.15);\n    }\n    .message.show { transform: translateX(0); }\n    .message-success { background-color: #16a34a; }\n    .message-error { background-color: #dc2626; }\n  ",document.head.appendChild(e)}document.addEventListener("DOMContentLoaded",function(){initializeProjectDetail()}),addErrorStyles(),window.ProjectDetail={navigateGallery:navigateGallery,submitContactForm:submitContactForm,showSuccessMessage:showSuccessMessage,showErrorMessage:showErrorMessage};