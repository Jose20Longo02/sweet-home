<% title = 'Edit Property' %>
<link rel="stylesheet" href="/css/admin/new-property.css" />

<div id="np-data"
     data-locations='<%- JSON.stringify(locations).replace(/'/g, '&#39;') %>'
     data-projects='<%- JSON.stringify(projects || []).replace(/'/g, '&#39;') %>'
     data-default-city="<%- (property.city||'').replace(/"/g,'&quot;') %>"
     data-default-hood="<%- (property.neighborhood||'').replace(/"/g,'&quot;') %>"></div>

<div class="new-prop-page">
  <header class="np-header">
    <div class="left">
      <h1>Edit Property</h1>
      <p class="subtitle">Update listing details. Fields change based on property type.</p>
    </div>
    <div class="right">
      <a href="<%= backUrl || (currentUser && currentUser.role==='SuperAdmin' ? '/superadmin/dashboard/properties' : '/admin/dashboard/my-properties') %>" class="btn btn-light">Back</a>
    </div>
  </header>

  <% if (error) { %>
    <div class="alert alert-error"><%= error %></div>
  <% } %>

  <form id="propertyForm" class="np-form" method="post" action="/properties/<%= property.id %>?_csrf=<%= csrfToken %>" enctype="multipart/form-data">
    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
    <input type="hidden" name="return_to" value="<%= backUrl || '' %>">

    <!-- A. Location -->
    <section class="card">
      <h2>Location</h2>
      <div class="grid-3">
        <div class="field">
          <label for="country">Country<span class="req">*</span></label>
          <select id="country" name="country" required>
            <option value="">Select country</option>
            <% Object.keys(locations).forEach(c => { %>
              <option value="<%= c %>" <%= property.country===c?'selected':'' %>><%= c %></option>
            <% }) %>
          </select>
        </div>
        <div class="field">
          <label for="city">City<span class="req">*</span></label>
          <select id="city" name="city" required></select>
        </div>
        <div class="field">
          <label for="neighborhood">Neighborhood</label>
          <select id="neighborhood" name="neighborhood"></select>
        </div>
      </div>
      
      <div class="field">
        <label for="map_link">Map link or "lat,lng"</label>
        <input id="map_link" name="map_link" type="text" placeholder="Paste Google Maps / OpenStreetMap link or 40.4168,-3.7038" value="<%= property.map_link||'' %>" />
        <small>Optional: If provided and coordinates are empty, we will extract coordinates from this.</small>
      </div>
    </section>

    <!-- Sold Status -->
    <section class="card">
      <h2>Status</h2>
      <div class="grid-2">
        <label class="checkbox">
          <input type="checkbox" id="sold" name="sold" <%= property.sold ? 'checked' : '' %> />
          <span>Mark as sold</span>
        </label>
        <div class="field">
          <label for="sold_at">Sold at (optional override)</label>
          <input id="sold_at" name="sold_at" type="datetime-local" value="<%= property.sold_at ? new Date(property.sold_at).toISOString().slice(0,16) : '' %>" />
          <small>If empty and checked, we set it to now.</small>
        </div>
      </div>
    </section>

    <!-- B2. Features -->
    <section class="card" id="featuresSection">
      <h2>Features</h2>
      <div class="chips">
        <% const FEATURE_OPTIONS = ['garden','balcony','parking','elevator','air_conditioning','pool','furnished','terrace','sea_view','storage','fireplace','separate_kitchen']; %>
        <% FEATURE_OPTIONS.forEach(f => { %>
          <label class="chip">
            <input type="checkbox" name="features" value="<%= f %>" <%= (property.features||[]).includes(f)?'checked':'' %> />
            <span><%= f.replace(/_/g,' ') %></span>
          </label>
        <% }) %>
      </div>
    </section>

    <!-- B. Basics -->
    <section class="card">
      <h2>Basics</h2>
      <div class="grid-2">
        <div class="field">
          <label for="title">Title<span class="req">*</span></label>
          <input id="title" name="title" type="text" maxlength="255" required value="<%= property.title %>" />
        </div>
        <div class="field">
          <label for="content_language">Content Language<span class="req">*</span></label>
          <select id="content_language" name="content_language" required>
            <option value="">Select language</option>
            <option value="auto" <%= property.content_language==='auto'?'selected':'' %>>Auto-detect</option>
            <option value="en" <%= property.content_language==='en'?'selected':'' %>>English</option>
            <option value="de" <%= property.content_language==='de'?'selected':'' %>>German</option>
            <option value="es" <%= property.content_language==='es'?'selected':'' %>>Spanish</option>
          </select>
          <small>Choose the language of your title and description. Auto-detect will try to determine it automatically.</small>
        </div>
        <div class="field">
          <label for="type">Type<span class="req">*</span></label>
          <select id="type" name="type" required>
            <% ['Apartment','House','Villa','Land'].forEach(t => { %>
              <option value="<%= t %>" <%= property.type===t?'selected':'' %>><%= t %></option>
            <% }) %>
          </select>
        </div>
      </div>
      <div class="grid-2">
        <div class="field">
          <label for="agent_id">Assigned team member<span class="req">*</span></label>
          <select id="agent_id" name="agent_id" required>
            <% (teamMembers || []).forEach(m => { %>
              <option value="<%= m.id %>" <%= String(property.agent_id)===String(m.id)?'selected':'' %>><%= m.name %></option>
            <% }) %>
          </select>
        </div>
      </div>
      <div class="field">
        <label for="description">Description<span class="req">*</span></label>
        <textarea id="description" name="description" rows="6" required><%= property.description||'' %></textarea>
      </div>
      <div class="grid-3">
        <div class="field">
          <label for="price_display">Price<span class="req">*</span></label>
          <input id="price_display" type="text" inputmode="decimal" placeholder="€0.00" required />
          <input id="price" name="price" type="hidden" value="<%= property.price||'' %>" />
        </div>
        <div class="field">
          <label>Status tags</label>
          <div class="chips">
            <% ['New','Reduced','Exclusive'].forEach(s => { %>
              <label class="chip">
                <input type="checkbox" name="status_tags" value="<%= s %>" <%= (property.status_tags||[]).includes(s)?'checked':'' %> />
                <span><%= s %></span>
              </label>
            <% }) %>
          </div>
        </div>
        <div class="field" id="yearBuiltField">
          <label for="year_built">Year Built</label>
          <input id="year_built" name="year_built" type="number" min="1800" max="<%= new Date().getFullYear() %>" value="<%= property.year_built||'' %>" />
        </div>
      </div>
    </section>

    <!-- B3. Occupancy & Rental -->
    <section class="card">
      <h2>Occupancy & Rental</h2>
      <div class="grid-3">
        <div class="field">
          <label for="occupancy_type">Property Type (occupancy)</label>
          <select id="occupancy_type" name="occupancy_type">
            <option value="">Select</option>
            <% ['Empty','Short-Term Rented','Suitable for Self Use','Long-Term Rented'].forEach(v => { %>
              <option value="<%= v %>" <%= String(property.occupancy_type||'')===v?'selected':'' %>><%= v %></option>
            <% }) %>
          </select>
        </div>
        <div class="field">
          <label for="rental_status">Rental Income</label>
          <select id="rental_status" name="rental_status">
            <option value="">Select</option>
            <option value="not_rented" <%= property.rental_status==='not_rented'?'selected':'' %>>Not rented</option>
            <option value="not_rented_potential" <%= property.rental_status==='not_rented_potential'?'selected':'' %>>Not rented (with potential)</option>
            <option value="rented" <%= property.rental_status==='rented'?'selected':'' %>>Rented</option>
          </select>
        </div>
        <div class="field" id="rentalIncomeWrap" hidden>
          <label for="rental_income">Rental Income (€ / month)</label>
          <input id="rental_income" name="rental_income" type="number" inputmode="decimal" step="0.01" min="0" value="<%= property.rental_income||'' %>" />
          <small>Fill when "Rented" or when adding potential income.</small>
        </div>
      </div>
      <div class="grid-3">
        <div class="field">
          <label for="housegeld">Housegeld (€ / month)</label>
          <input id="housegeld" name="housegeld" type="number" inputmode="decimal" step="0.01" min="0" value="<%= property.housegeld||'' %>" />
        </div>
      </div>
    </section>

    <!-- C. Media -->
    <section class="card">
      <h2>Media</h2>
      <div class="field">
        <label for="photos">Photos</label>
        <input id="photos" name="photos" type="file" accept="image/*" multiple />
        <small>Upload 1–20 images. Leave empty to keep existing order.</small>
        <div class="preview-grid" id="photoPreview">
          <% (property.photos || []).forEach((ph) => { %>
            <div class="item" style="position:relative">
              <img class="thumb" src="<%= ph %>">
              <button type="button" class="remove-btn" data-remove-photo="<%= ph %>" aria-label="Remove" style="position:absolute;right:6px;top:6px;width:24px;height:24px;border-radius:50%;border:none;background:rgba(0,0,0,0.6);color:#fff;cursor:pointer">×</button>
            </div>
          <% }) %>
        </div>
        <!-- Ordered existing photos will be posted here -->
        <div id="orderedExistingPhotos"></div>
      </div>

      <div class="grid-3">
        <div class="field">
          <label>Video source</label>
          <div class="chips">
            <label class="chip"><input type="radio" name="video_source" id="videoSrcUpload" value="upload" checked /> <span>Upload</span></label>
            <label class="chip"><input type="radio" name="video_source" id="videoSrcLink" value="link" /> <span>Link</span></label>
          </div>
        </div>
        <div class="field" id="videoUploadWrap">
          <label for="video">Upload new video</label>
          <input id="video" name="video" type="file" accept="video/*" />
          <div id="videoPreview" class="video-preview">
            <% if (property.video_url) { %>
              <div style="position:relative;display:inline-block">
                <video src="<%= property.video_url %>" controls playsinline style="max-width:100%; border-radius:8px;"></video>
                <button type="button" class="remove-btn" data-remove-video="true" aria-label="Remove video" style="position:absolute;right:6px;top:6px;width:24px;height:24px;border-radius:50%;border:none;background:rgba(0,0,0,0.6);color:#fff;cursor:pointer">×</button>
              </div>
            <% } %>
          </div>
          <input type="hidden" id="remove_existing_video" name="remove_existing_video" value="false" />
          <input type="hidden" id="remove_existing_photos" name="remove_existing_photos" value="" />
        </div>
        <div class="field" id="videoUrlWrap" hidden>
          <label for="video_url">Video URL</label>
          <input id="video_url" name="video_url" type="url" placeholder="https://..." value="" />
          <% if (property.video_url) { %>
            <small>Current: <a href="<%= property.video_url %>" target="_blank">Open</a></small>
          <% } %>
        </div>
      </div>
    </section>

    <!-- D. Project -->
    <section class="card">
      <h2>Project</h2>
      <div class="grid-2">
        <label class="checkbox">
          <input type="checkbox" id="is_in_project" name="is_in_project" <%= property.is_in_project?'checked':'' %> />
          <span>Part of a project</span>
        </label>
        <div class="field" id="projectWrap" hidden>
          <label for="project_id">Project</label>
          <select id="project_id" name="project_id" disabled>
            <option value="">Select project</option>
            <% (projects||[]).forEach(p => { %>
              <option value="<%= p.id %>" <%= String(property.project_id||'')===String(p.id)?'selected':'' %>><%= p.title %></option>
            <% }) %>
          </select>
        </div>
      </div>
    </section>

    <!-- E. Type-specific -->
    <section class="card">
      <h2>Type-specific</h2>
      <div id="typeApartment" class="type-block" hidden>
        <div class="grid-4">
          <div class="field">
            <label for="apartment_size">Apartment size (sqm)<span class="req">*</span></label>
            <input id="apartment_size" name="apartment_size" type="number" min="0" step="0.01" value="<%= property.apartment_size || '' %>" />
          </div>
          <div class="field">
            <label for="rooms_a">Rooms<span class="req">*</span></label>
            <input id="rooms_a" name="rooms" type="number" min="0" step="0.5" value="<%= property.rooms ?? '' %>" />
          </div>
          <div class="field">
            <label for="bathrooms_a">Bathrooms<span class="req">*</span></label>
            <input id="bathrooms_a" name="bathrooms" type="number" min="0" step="0.5" value="<%= property.bathrooms ?? '' %>" />
          </div>
          <div class="field">
            <label for="floorplan">Floorplan image</label>
            <input id="floorplan" name="floorplan" type="file" accept="image/*" />
            <div class="preview-grid" id="floorplanPreview">
              <% if (property.floorplan_url) { %>
                <div class="item" style="position:relative">
                  <img class="thumb" src="<%= property.floorplan_url %>">
                </div>
              <% } %>
            </div>
          </div>
        </div>
      </div>

      <div id="typeHouseVilla" class="type-block" hidden>
        <div class="grid-4">
          <div class="field">
            <label for="total_size">Total lot size (sqm)<span class="req">*</span></label>
            <input id="total_size" name="total_size" type="number" min="0" step="0.01" value="<%= property.total_size || '' %>" />
          </div>
          <div class="field">
            <label for="living_space">Living space (sqm)</label>
            <input id="living_space" name="living_space" type="number" min="0" step="0.01" value="<%= property.living_space || '' %>" />
          </div>
          <div class="field">
            <label for="rooms_hv">Rooms<span class="req">*</span></label>
            <input id="rooms_hv" name="rooms" type="number" min="0" step="0.5" value="<%= property.rooms ?? '' %>" />
          </div>
          <div class="field">
            <label for="bathrooms_hv">Bathrooms<span class="req">*</span></label>
            <input id="bathrooms_hv" name="bathrooms" type="number" min="0" step="0.5" value="<%= property.bathrooms ?? '' %>" />
          </div>
          <div class="field">
            <label for="plan_photo_hv">Plan image</label>
            <input id="plan_photo_hv" name="plan_photo" type="file" accept="image/*" />
            <div class="preview-grid" id="planPhotoPreviewHV">
              <% if (property.plan_photo_url) { %>
                <div class="item" style="position:relative"><img class="thumb" src="<%= property.plan_photo_url %>"></div>
              <% } %>
            </div>
          </div>
        </div>
      </div>

      <div id="typeLand" class="type-block" hidden>
        <div class="grid-3">
          <div class="field">
            <label for="land_size">Land size (sqm)<span class="req">*</span></label>
            <input id="land_size" name="land_size" type="number" min="0" step="0.01" value="<%= property.land_size || '' %>" />
          </div>
          <div class="field">
            <label for="plan_photo">Plan image</label>
            <input id="plan_photo" name="plan_photo" type="file" accept="image/*" />
            <div class="preview-grid" id="planPhotoPreview">
              <% if (property.plan_photo_url) { %>
                <div class="item" style="position:relative"><img class="thumb" src="<%= property.plan_photo_url %>"></div>
              <% } %>
            </div>
          </div>
        </div>
      </div>
      <input type="hidden" id="remove_existing_floorplan" name="remove_existing_floorplan" value="false" />
      <input type="hidden" id="remove_existing_plan_photo" name="remove_existing_plan_photo" value="false" />
    </section>

    <!-- F. Submit -->
    <section class="card">
      <div class="actions">
        <button type="submit" class="btn btn-primary">Save Changes</button>
      </div>
    </section>
  </form>
</div>

<!-- Uploading Overlay -->
<div id="uploadOverlay" class="upload-overlay" hidden style="display:none;">
  <div class="upload-dialog">
    <div class="upload-spinner"></div>
    <div>
      <div class="upload-title">Uploading...</div>
      <div class="upload-sub">This may take a moment. Please don’t close this page.</div>
    </div>
  </div>
  <style>
    .upload-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.45); display: flex; align-items: center; justify-content: center; z-index: 3000; }
    .upload-dialog { background: #ffffff; border-radius: 12px; padding: 18px 22px; box-shadow: 0 10px 30px rgba(0,0,0,.25); display: flex; align-items: center; gap: 12px; min-width: 280px; }
    .upload-spinner { width: 22px; height: 22px; border: 3px solid #e5e7eb; border-top-color: var(--primary-color); border-radius: 50%; animation: upload-spin 1s linear infinite; }
    .upload-title { font-family: 'Lato', system-ui, -apple-system, Segoe UI, Roboto, sans-serif; font-weight: 600; color: #111; }
    .upload-sub { font-size: 12px; color: #666; margin-top: 2px; }
    @keyframes upload-spin { to { transform: rotate(360deg); } }
  </style>
</div>

<script src="/js/admin-edit-property.js" defer></script>

