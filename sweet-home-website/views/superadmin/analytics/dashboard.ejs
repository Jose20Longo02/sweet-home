<head>
  <link rel="stylesheet" href="/css/superadmin/analytics.css?v=<%= assetVersion %>" />
  <script src="https://unpkg.com/chart.js@4.4.1/dist/chart.umd.min.js" onerror="console.error('Failed to load Chart.js from unpkg.com'); document.getElementById('chartLoading').innerHTML = '<p style=\'margin: 0; color: #ef4444;\'>Failed to load chart library. Please refresh the page.</p>';"></script>
</head>

<% title = 'Analytics' %>

<div class="admin-panel analytics-page">
  <div class="admin-body">
    <%- include('../../partials/superadmin-sidebar', {
      activePage: 'analytics',
      pendingCount
    }) %>

    <main class="admin-content">
      <header class="analytics-header">
        <div>
          <h1>Performance Analytics</h1>
          <p class="subtitle">Track traffic, engagement, and lead activity across the site</p>
        </div>
        <span class="metric-pill">Ranking by <strong><%= metric === 'forms' ? 'Form Submissions' : 'Views' %></strong></span>
      </header>

      <section class="filters-card">
        <form method="GET" action="/superadmin/dashboard/analytics" class="filters-form" id="analyticsFilterForm">
          <div class="filters-row">
            <div class="field">
              <label for="date_from">From</label>
              <input type="date" id="date_from" name="date_from" value="<%= dateFrom %>" required />
            </div>
            <div class="field">
              <label for="date_to">To</label>
              <input type="date" id="date_to" name="date_to" value="<%= dateTo %>" required />
            </div>
            <div class="field">
              <label for="metric">Rank By</label>
              <select id="metric" name="metric">
                <option value="views" <%= metric === 'views' ? 'selected' : '' %>>Views</option>
                <option value="forms" <%= metric === 'forms' ? 'selected' : '' %>>Form submissions</option>
              </select>
            </div>
            <div class="field actions">
              <button type="submit" class="btn-primary">Apply</button>
              <a class="btn-secondary" href="/superadmin/dashboard/analytics">Reset</a>
            </div>
          </div>
          <div class="quick-ranges">
            <span>Quick ranges:</span>
            <button type="submit" name="quick_range" value="today" data-range="today" class="<%= quickRange === 'today' ? 'active' : '' %>">Today</button>
            <button type="submit" name="quick_range" value="7" data-range="7" class="<%= quickRange === '7' ? 'active' : '' %>">Last 7 days</button>
            <button type="submit" name="quick_range" value="30" data-range="30" class="<%= quickRange === '30' ? 'active' : '' %>">Last 30 days</button>
            <button type="submit" name="quick_range" value="90" data-range="90" class="<%= quickRange === '90' ? 'active' : '' %>">Last 90 days</button>
            <button type="submit" name="quick_range" value="365" data-range="365" class="<%= quickRange === '365' ? 'active' : '' %>">Last 12 months</button>
            <button type="submit" name="quick_range" value="ytd" data-range="ytd" class="<%= quickRange === 'ytd' ? 'active' : '' %>">Year to date</button>
          </div>
        </form>
      </section>

      <section class="summary-grid">
        <div class="summary-card">
          <p class="label">Total visits</p>
          <p class="value"><%= (summary.total_visits || 0).toLocaleString() %></p>
        </div>
        <div class="summary-card">
          <p class="label">Property views</p>
          <p class="value"><%= (summary.property_views || 0).toLocaleString() %></p>
        </div>
        <div class="summary-card">
          <p class="label">Project views</p>
          <p class="value"><%= (summary.project_views || 0).toLocaleString() %></p>
        </div>
        <div class="summary-card">
          <p class="label">Form submissions</p>
          <p class="value"><%= (summary.form_submissions || 0).toLocaleString() %></p>
        </div>
      </section>

      <section class="panel">
        <div class="panel-header">
          <div>
            <h2>Traffic overview</h2>
            <p>Daily breakdown of visits, property interest, and leads</p>
          </div>
        </div>
        <div class="chart-container" style="position: relative; height: 300px; margin-top: 1rem;">
          <canvas id="trafficChart" style="display: none;"></canvas>
          <div id="chartLoading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #64748b; font-size: 14px; text-align: center;">Loading chart...</div>
          <div id="chartError" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #64748b; font-size: 14px; text-align: center; padding: 1rem;"></div>
        </div>
      </section>

      <section class="grid two-columns">
        <div class="panel">
          <div class="panel-header">
            <h2>Top properties (<%= metric === 'forms' ? 'Leads' : 'Views' %>)</h2>
          </div>
          <% if (!topProperties.length) { %>
            <p class="empty-state">No property activity in this range.</p>
          <% } else { %>
            <table class="analytics-table">
              <thead>
                <tr>
                  <th>Property</th>
                  <th>Location</th>
                  <th>Views</th>
                  <th>Form submissions</th>
                </tr>
              </thead>
              <tbody>
                <% topProperties.forEach(item => { %>
                  <tr>
                    <td><span class="line-clamp"><%= item.title %></span></td>
                    <td><%= item.city || '—' %>, <%= item.country || '—' %></td>
                    <td class="number"><%= (item.total_views || 0).toLocaleString() %></td>
                    <td class="number"><%= (item.total_leads || 0).toLocaleString() %></td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          <% } %>
        </div>

        <div class="panel">
          <div class="panel-header">
            <h2>Top projects (<%= metric === 'forms' ? 'Leads' : 'Views' %>)</h2>
          </div>
          <% if (!topProjects.length) { %>
            <p class="empty-state">No project activity in this range.</p>
          <% } else { %>
            <table class="analytics-table">
              <thead>
                <tr>
                  <th>Project</th>
                  <th>Location</th>
                  <th>Views</th>
                  <th>Form submissions</th>
                </tr>
              </thead>
              <tbody>
                <% topProjects.forEach(item => { %>
                  <tr>
                    <td><span class="line-clamp"><%= item.title %></span></td>
                    <td><%= item.city || '—' %>, <%= item.country || '—' %></td>
                    <td class="number"><%= (item.total_views || 0).toLocaleString() %></td>
                    <td class="number"><%= (item.total_leads || 0).toLocaleString() %></td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          <% } %>
        </div>
      </section>

      <section class="grid two-columns">
        <div class="panel">
          <div class="panel-header">
            <h2>Top agents</h2>
          </div>
          <% if (!agentPerformance.length) { %>
            <p class="empty-state">No agent activity captured yet.</p>
          <% } else { %>
            <table class="analytics-table">
              <thead>
                <tr>
                  <th>Agent</th>
                  <th>Views</th>
                  <th>Form submissions</th>
                </tr>
              </thead>
              <tbody>
                <% agentPerformance.forEach(agent => { %>
                  <tr>
                    <td><%= agent.name || 'N/A' %></td>
                    <td class="number"><%= (agent.total_views || 0).toLocaleString() %></td>
                    <td class="number"><%= (agent.total_form_submissions || 0).toLocaleString() %></td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          <% } %>
        </div>
        <div class="panel">
          <div class="panel-header">
            <h2>Top pages</h2>
          </div>
          <% if (!topPages.length) { %>
            <p class="empty-state">No page views recorded yet.</p>
          <% } else { %>
            <table class="analytics-table">
              <thead>
                <tr>
                  <th>Page</th>
                  <th>Visits</th>
                </tr>
              </thead>
              <tbody>
                <% topPages.forEach(page => { %>
                  <tr>
                    <td><span class="line-clamp"><%= page.path || '/' %></span></td>
                    <td class="number"><%= (page.views || 0).toLocaleString() %></td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          <% } %>
        </div>
      </section>

      <section class="grid two-columns">
        <div class="panel">
          <div class="panel-header">
            <h2>Hot locations</h2>
          </div>
          <% if (!locationInsights.length) { %>
            <p class="empty-state">No location activity yet.</p>
          <% } else { %>
            <table class="analytics-table">
              <thead>
                <tr>
                  <th>Location</th>
                  <th>Views</th>
                  <th>Leads</th>
                </tr>
              </thead>
              <tbody>
                <% locationInsights.forEach(row => { %>
                  <tr>
                    <td><%= (row.city || '—') %>, <%= row.country || '' %></td>
                    <td class="number"><%= (row.total_views || 0).toLocaleString() %></td>
                    <td class="number"><%= (row.total_leads || 0).toLocaleString() %></td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          <% } %>
        </div>

        <div class="panel">
          <div class="panel-header">
            <h2>Latest leads</h2>
          </div>
          <% if (!recentLeads.length) { %>
            <p class="empty-state">No leads captured in this period.</p>
          <% } else { %>
            <table class="analytics-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Interest</th>
                  <th>Source</th>
                  <th>Created</th>
                </tr>
              </thead>
              <tbody>
                <% recentLeads.forEach(lead => { %>
                  <tr>
                    <td><%= lead.name || 'Anonymous' %></td>
                    <td>
                      <% if (lead.property_title) { %>
                        <span>Property: <%= lead.property_title %></span>
                      <% } else if (lead.project_title) { %>
                        <span>Project: <%= lead.project_title %></span>
                      <% } else { %>
                        <span>General inquiry</span>
                      <% } %>
                    </td>
                    <td><%= (lead.source || 'contact_form').replace('_', ' ') %></td>
                    <td><%= new Date(lead.created_at).toLocaleString() %></td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          <% } %>
        </div>
      </section>
    </main>
  </div>
</div>

<script src="https://unpkg.com/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const fromInput = document.getElementById('date_from');
    const toInput = document.getElementById('date_to');
    const quickButtons = document.querySelectorAll('.quick-ranges button');

    function parseDate(str) {
      if (!str) return null;
      return new Date(`${str}T00:00:00`);
    }

    function highlightRange(range) {
      quickButtons.forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-range') === range);
      });
    }

    function detectRange() {
      const fromDate = parseDate(fromInput.value);
      const toDate = parseDate(toInput.value);
      if (!fromDate || !toDate) return null;
      const today = new Date();
      today.setHours(0,0,0,0);
      const diffMs = toDate - fromDate;
      const diffDays = Math.round(diffMs / 86400000) + 1;
      if (diffDays === 1 && toDate.getTime() === today.getTime()) return 'today';
      if (toDate.getTime() === today.getTime()) {
        const presets = [7, 30, 90, 365];
        const match = presets.find(days => diffDays === days);
        if (match) return String(match);
      }
      const ytdStart = new Date(today.getFullYear(), 0, 1);
      if (toDate.getTime() === today.getTime() && fromDate.getTime() === ytdStart.getTime()) {
        return 'ytd';
      }
      return null;
    }

    const initialRange = "<%= (typeof quickRange !== 'undefined' ? quickRange : '') %>";
    if (initialRange) {
      highlightRange(initialRange);
    } else {
      const detected = detectRange();
      if (detected) highlightRange(detected);
    }
  });

  function initChart() {
    const ctx = document.getElementById('trafficChart');
    const loadingEl = document.getElementById('chartLoading');
    const errorEl = document.getElementById('chartError');
    
    if (!ctx) {
      console.error('Chart canvas not found');
      if (loadingEl) loadingEl.style.display = 'none';
      if (errorEl) {
        errorEl.textContent = 'Chart canvas not found';
        errorEl.style.display = 'block';
      }
      return;
    }
    
    // Debug: Check what Chart.js exports
    console.log('Chart.js check:', {
      'typeof Chart': typeof Chart,
      'Chart.Chart': typeof Chart !== 'undefined' ? typeof Chart.Chart : 'N/A',
      'window.Chart': typeof window !== 'undefined' && typeof window.Chart !== 'undefined' ? typeof window.Chart : 'N/A'
    });
    
    // Wait for Chart.js to be available - try multiple ways
    let ChartConstructor = null;
    if (typeof Chart !== 'undefined') {
      if (Chart.Chart) {
        ChartConstructor = Chart.Chart;
      } else if (typeof Chart === 'function') {
        ChartConstructor = Chart;
      }
    } else if (typeof window !== 'undefined' && typeof window.Chart !== 'undefined') {
      if (window.Chart.Chart) {
        ChartConstructor = window.Chart.Chart;
      } else if (typeof window.Chart === 'function') {
        ChartConstructor = window.Chart;
      }
    }
    
    if (!ChartConstructor) {
      setTimeout(initChart, 100);
      return;
    }
    
    // Hide loading message
    if (loadingEl) loadingEl.style.display = 'none';
    if (errorEl) errorEl.style.display = 'none';
    
    const series = <%- JSON.stringify(timeSeries || []) %>;
    
    if (!series || series.length === 0) {
      if (loadingEl) {
        loadingEl.innerHTML = '<p style="margin: 0; color: #64748b;">No data available for the selected date range.</p>';
        loadingEl.style.display = 'block';
      }
      return;
    }
    
    // Process data
    const labels = series.map(item => {
      const dateStr = item.date;
      let date;
      if (typeof dateStr === 'string') {
        date = new Date(dateStr);
      } else {
        date = new Date(dateStr);
      }
      if (isNaN(date.getTime())) {
        return dateStr; // Fallback to original string if date is invalid
      }
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    });
    
    const pageViews = series.map(item => Number(item.page_views || 0));
    const propertyViews = series.map(item => Number(item.property_views || 0));
    const projectViews = series.map(item => Number(item.project_views || 0));
    const formSubmissions = series.map(item => Number(item.form_submissions || 0));

    try {
      // Show canvas
      ctx.style.display = 'block';
      
      // Destroy existing chart if it exists
      if (ctx.chart) {
        ctx.chart.destroy();
      }
      
      // Use the Chart constructor we found
      ctx.chart = new ChartConstructor(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          {
            label: 'Page views',
            data: pageViews,
            borderColor: '#2ea862',
            backgroundColor: 'rgba(46, 168, 98, 0.08)',
            borderWidth: 3,
            tension: 0.4,
            fill: true,
            pointRadius: 5,
            pointHoverRadius: 7,
            pointBackgroundColor: '#2ea862',
            pointBorderColor: '#ffffff',
            pointBorderWidth: 2.5,
            pointHoverBackgroundColor: '#23824b',
            pointHoverBorderColor: '#ffffff',
            pointHoverBorderWidth: 3
          },
          {
            label: 'Property views',
            data: propertyViews,
            borderColor: '#23824b',
            backgroundColor: 'rgba(35, 130, 75, 0.08)',
            borderWidth: 3,
            tension: 0.4,
            fill: true,
            pointRadius: 5,
            pointHoverRadius: 7,
            pointBackgroundColor: '#23824b',
            pointBorderColor: '#ffffff',
            pointBorderWidth: 2.5,
            pointHoverBackgroundColor: '#1e6b3f',
            pointHoverBorderColor: '#ffffff',
            pointHoverBorderWidth: 3
          },
          {
            label: 'Project views',
            data: projectViews,
            borderColor: '#2ea862',
            backgroundColor: 'rgba(46, 168, 98, 0.06)',
            borderWidth: 2.5,
            tension: 0.4,
            fill: true,
            pointRadius: 4,
            pointHoverRadius: 6,
            pointBackgroundColor: '#2ea862',
            pointBorderColor: '#ffffff',
            pointBorderWidth: 2,
            pointHoverBackgroundColor: '#23824b',
            pointHoverBorderColor: '#ffffff',
            pointHoverBorderWidth: 2.5,
            borderDash: [5, 5]
          },
          {
            label: 'Form submissions',
            data: formSubmissions,
            borderColor: '#23824b',
            backgroundColor: 'rgba(35, 130, 75, 0.06)',
            borderWidth: 2.5,
            tension: 0.4,
            fill: true,
            pointRadius: 4,
            pointHoverRadius: 6,
            pointBackgroundColor: '#23824b',
            pointBorderColor: '#ffffff',
            pointBorderWidth: 2,
            pointHoverBackgroundColor: '#1e6b3f',
            pointHoverBorderColor: '#ffffff',
            pointHoverBorderWidth: 2.5,
            borderDash: [8, 4]
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: 'index',
          intersect: false
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: { 
              stepSize: 1,
              font: { size: 12, weight: '500' },
              color: '#64748b',
              padding: 8
            },
            grid: {
              color: 'rgba(46, 168, 98, 0.08)',
              drawBorder: false,
              lineWidth: 1
            }
          },
          x: {
            ticks: {
              font: { size: 12, weight: '500' },
              color: '#64748b',
              padding: 8
            },
            grid: {
              display: false
            }
          }
        },
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              padding: 15,
              font: { size: 12, weight: '500' },
              usePointStyle: true,
              pointStyle: 'circle'
            }
          },
          tooltip: {
            backgroundColor: 'rgba(15, 23, 42, 0.98)',
            padding: 14,
            titleFont: { size: 13, weight: '700' },
            bodyFont: { size: 12, weight: '500' },
            borderColor: '#2ea862',
            borderWidth: 2,
            cornerRadius: 10,
            displayColors: true,
            titleColor: '#ffffff',
            bodyColor: '#f1f5f9',
            titleSpacing: 6,
            bodySpacing: 4,
            boxPadding: 8
          }
        }
      }
    });
    
    // Chart initialized successfully
    } catch (error) {
      console.error('Error initializing chart:', error);
      ctx.style.display = 'none';
      if (loadingEl) loadingEl.style.display = 'none';
      if (errorEl) {
        errorEl.innerHTML = '<p style="margin: 0; color: #ef4444;">Error loading chart: ' + error.message + '</p>';
        errorEl.style.display = 'block';
      }
    }
  }

  // Initialize chart when DOM and Chart.js are ready
  function startChartInit() {
    let attempts = 0;
    const maxAttempts = 50; // 5 seconds max wait
    const loadingEl = document.getElementById('chartLoading');
    const errorEl = document.getElementById('chartError');
    
    function tryInit() {
      attempts++;
      // Check if Chart.js is available (try multiple ways)
      const chartAvailable = (typeof Chart !== 'undefined' && (Chart.Chart || typeof Chart === 'function'));
      
      if (chartAvailable) {
        initChart();
      } else if (attempts < maxAttempts) {
        setTimeout(tryInit, 100);
      } else {
        console.error('Chart.js failed to load after', maxAttempts, 'attempts. Chart type:', typeof Chart);
        if (loadingEl) loadingEl.style.display = 'none';
        if (errorEl) {
          errorEl.innerHTML = '<p style="margin: 0; color: #ef4444;">Failed to load chart library after 5 seconds. Please check your internet connection and refresh the page.</p><p style="margin: 0.5rem 0 0 0; color: #64748b; font-size: 12px;">If the problem persists, the CDN may be blocked. Contact your administrator.</p>';
          errorEl.style.display = 'block';
        }
      }
    }
    
    tryInit();
  }
  
  // Start initialization when page is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(startChartInit, 100); // Small delay to ensure scripts are loaded
    });
  } else {
    setTimeout(startChartInit, 100);
  }
</script>

