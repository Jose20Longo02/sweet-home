<head>
  <link rel="stylesheet" href="/css/superadmin/analytics.css?v=<%= assetVersion %>" />
</head>

<% title = 'Analytics' %>

<div class="admin-panel analytics-page"
  data-time-series='<%- JSON.stringify(timeSeries || []).replace(/'/g, '&#39;') %>'
  data-quick-range="<%= typeof quickRange !== 'undefined' ? quickRange : '' %>">
  <div class="admin-body">
    <%- include('../../partials/superadmin-sidebar', {
      activePage: 'analytics',
      pendingCount
    }) %>

    <main class="admin-content">
      <header class="analytics-header">
        <div>
          <h1>Performance Analytics</h1>
          <p class="subtitle">Track traffic, engagement, and lead activity across the site</p>
        </div>
        <span class="metric-pill">Ranking by <strong><%= metric === 'forms' ? 'Form Submissions' : 'Views' %></strong></span>
      </header>

      <section class="filters-card">
        <form method="GET" action="/superadmin/dashboard/analytics" class="filters-form" id="analyticsFilterForm">
          <div class="filters-row">
            <div class="field">
              <label for="date_from">From</label>
              <input type="date" id="date_from" name="date_from" value="<%= dateFrom %>" required />
            </div>
            <div class="field">
              <label for="date_to">To</label>
              <input type="date" id="date_to" name="date_to" value="<%= dateTo %>" required />
            </div>
            <div class="field">
              <label for="metric">Rank By</label>
              <select id="metric" name="metric">
                <option value="views" <%= metric === 'views' ? 'selected' : '' %>>Views</option>
                <option value="forms" <%= metric === 'forms' ? 'selected' : '' %>>Form submissions</option>
              </select>
            </div>
            <div class="field actions">
              <button type="submit" class="btn-primary">Apply</button>
              <a class="btn-secondary" href="/superadmin/dashboard/analytics">Reset</a>
            </div>
          </div>
          <div class="quick-ranges">
            <span>Quick ranges:</span>
            <button type="submit" name="quick_range" value="today" data-range="today" class="<%= quickRange === 'today' ? 'active' : '' %>">Today</button>
            <button type="submit" name="quick_range" value="7" data-range="7" class="<%= quickRange === '7' ? 'active' : '' %>">Last 7 days</button>
            <button type="submit" name="quick_range" value="30" data-range="30" class="<%= quickRange === '30' ? 'active' : '' %>">Last 30 days</button>
            <button type="submit" name="quick_range" value="90" data-range="90" class="<%= quickRange === '90' ? 'active' : '' %>">Last 90 days</button>
            <button type="submit" name="quick_range" value="365" data-range="365" class="<%= quickRange === '365' ? 'active' : '' %>">Last 12 months</button>
            <button type="submit" name="quick_range" value="ytd" data-range="ytd" class="<%= quickRange === 'ytd' ? 'active' : '' %>">Year to date</button>
          </div>
        </form>
      </section>

      <section class="summary-grid">
        <div class="summary-card">
          <p class="label">Total visits</p>
          <p class="value"><%= (summary.total_visits || 0).toLocaleString() %></p>
        </div>
        <div class="summary-card">
          <p class="label">Property views</p>
          <p class="value"><%= (summary.property_views || 0).toLocaleString() %></p>
        </div>
        <div class="summary-card">
          <p class="label">Project views</p>
          <p class="value"><%= (summary.project_views || 0).toLocaleString() %></p>
        </div>
        <div class="summary-card">
          <p class="label">Form submissions</p>
          <p class="value"><%= (summary.form_submissions || 0).toLocaleString() %></p>
        </div>
      </section>

      <section class="panel">
        <div class="panel-header">
          <div>
            <h2>Traffic overview</h2>
            <p>Daily breakdown of visits, property interest, and leads</p>
          </div>
        </div>
        <div class="chart-container" style="position: relative; height: 300px; margin-top: 1rem;">
          <canvas id="trafficChart" style="display: none;"></canvas>
          <div id="chartLoading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #64748b; font-size: 14px; text-align: center;">Loading chart...</div>
          <div id="chartError" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #64748b; font-size: 14px; text-align: center; padding: 1rem;"></div>
        </div>
      </section>

      <section class="grid two-columns">
        <div class="panel">
          <div class="panel-header">
            <div>
              <h2>Top properties (<%= metric === 'forms' ? 'Leads' : 'Views' %>)</h2>
              <p>Showing <%= topProperties.length %> properties</p>
            </div>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
              <button type="button" class="btn-secondary filter-toggle-btn" data-target="propertyFilters">Filters</button>
              <a href="/superadmin/dashboard/analytics/export/properties?<%= new URLSearchParams({date_from: dateFrom, date_to: dateTo, metric, limit: limit || 40, property_search: typeof propertyFilters !== 'undefined' ? propertyFilters.search || '' : '', property_country: typeof propertyFilters !== 'undefined' ? propertyFilters.country || '' : '', property_city: typeof propertyFilters !== 'undefined' ? propertyFilters.city || '' : '', property_type: typeof propertyFilters !== 'undefined' ? propertyFilters.type || '' : '', property_min_price: typeof propertyFilters !== 'undefined' && propertyFilters.minPrice ? propertyFilters.minPrice : '', property_max_price: typeof propertyFilters !== 'undefined' && propertyFilters.maxPrice ? propertyFilters.maxPrice : '', property_min_rooms: typeof propertyFilters !== 'undefined' && propertyFilters.minRooms ? propertyFilters.minRooms : ''}).toString() %>" class="btn-export" title="Export to CSV">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M8 2V10M8 10L5 7M8 10L11 7M2 12H14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Export CSV
              </a>
            </div>
          </div>
          <div class="section-filters" id="propertyFilters" style="display: none;">
            <div class="filters-row">
              <div class="field">
                <label for="property_search">Search</label>
                <input type="text" id="property_search" name="property_search" placeholder="Search properties..." value="<%= typeof propertyFilters !== 'undefined' && propertyFilters.search ? propertyFilters.search : '' %>" />
              </div>
              <div class="field">
                <label for="property_country">Country</label>
                <select id="property_country" name="property_country">
                  <option value="">All countries</option>
                  <option value="Cyprus" <%= typeof propertyFilters !== 'undefined' && propertyFilters.country === 'Cyprus' ? 'selected' : '' %>>Cyprus</option>
                  <option value="UAE" <%= typeof propertyFilters !== 'undefined' && propertyFilters.country === 'UAE' ? 'selected' : '' %>>UAE</option>
                  <option value="Germany" <%= typeof propertyFilters !== 'undefined' && propertyFilters.country === 'Germany' ? 'selected' : '' %>>Germany</option>
                </select>
              </div>
              <div class="field">
                <label for="property_city">City</label>
                <input type="text" id="property_city" name="property_city" placeholder="City name" value="<%= typeof propertyFilters !== 'undefined' && propertyFilters.city ? propertyFilters.city : '' %>" />
              </div>
              <div class="field">
                <label for="property_type">Property Type</label>
                <select id="property_type" name="property_type">
                  <option value="">All types</option>
                  <option value="Apartment" <%= typeof propertyFilters !== 'undefined' && propertyFilters.type === 'Apartment' ? 'selected' : '' %>>Apartment</option>
                  <option value="House" <%= typeof propertyFilters !== 'undefined' && propertyFilters.type === 'House' ? 'selected' : '' %>>House</option>
                  <option value="Villa" <%= typeof propertyFilters !== 'undefined' && propertyFilters.type === 'Villa' ? 'selected' : '' %>>Villa</option>
                  <option value="Land" <%= typeof propertyFilters !== 'undefined' && propertyFilters.type === 'Land' ? 'selected' : '' %>>Land</option>
                </select>
              </div>
            </div>
            <div class="filters-row">
              <div class="field">
                <label for="property_min_price">Min Price</label>
                <input type="number" id="property_min_price" name="property_min_price" placeholder="0" value="<%= typeof propertyFilters !== 'undefined' && propertyFilters.minPrice ? propertyFilters.minPrice : '' %>" />
              </div>
              <div class="field">
                <label for="property_max_price">Max Price</label>
                <input type="number" id="property_max_price" name="property_max_price" placeholder="No limit" value="<%= typeof propertyFilters !== 'undefined' && propertyFilters.maxPrice ? propertyFilters.maxPrice : '' %>" />
              </div>
              <div class="field">
                <label for="property_min_rooms">Min Rooms</label>
                <input type="number" id="property_min_rooms" name="property_min_rooms" placeholder="0" min="0" value="<%= typeof propertyFilters !== 'undefined' && propertyFilters.minRooms ? propertyFilters.minRooms : '' %>" />
              </div>
              <div class="field actions">
                <button type="submit" class="btn-primary">Apply Filters</button>
                <button type="button" class="btn-secondary" onclick="document.getElementById('propertyFilters').style.display='none'">Cancel</button>
              </div>
            </div>
          </div>
          <% if (!topProperties.length) { %>
            <p class="empty-state">No property activity in this range.</p>
          <% } else { %>
            <div class="table-wrapper">
              <table class="analytics-table sortable-table" data-table="properties">
                <thead>
                  <tr>
                    <th class="sortable" data-column="title">Property <span class="sort-indicator"></span></th>
                    <th class="sortable" data-column="location">Location <span class="sort-indicator"></span></th>
                    <th class="sortable" data-column="views">Views <span class="sort-indicator"></span></th>
                    <th class="sortable" data-column="leads">Form submissions <span class="sort-indicator"></span></th>
                  </tr>
                </thead>
                <tbody>
                  <% topProperties.forEach(item => { %>
                    <tr data-title="<%= (item.title || '').toLowerCase() %>" data-location="<%= ((item.city || '') + ' ' + (item.country || '')).toLowerCase() %>" data-views="<%= item.total_views || 0 %>" data-leads="<%= item.total_leads || 0 %>">
                      <td>
                        <% if (item.slug) { %>
                          <a
                            href="/properties/<%= item.slug %>"
                            target="_blank"
                            rel="noopener"
                            class="table-link line-clamp"
                          ><%= item.title %></a>
                        <% } else { %>
                          <span class="line-clamp"><%= item.title %></span>
                        <% } %>
                      </td>
                      <td><%= item.city || '—' %>, <%= item.country || '—' %></td>
                      <td class="number"><%= (item.total_views || 0).toLocaleString() %></td>
                      <td class="number"><%= (item.total_leads || 0).toLocaleString() %></td>
                    </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
          <% } %>
        </div>

        <div class="panel">
          <div class="panel-header">
            <div>
              <h2>Top projects (<%= metric === 'forms' ? 'Leads' : 'Views' %>)</h2>
              <p>Showing <%= topProjects.length %> projects</p>
            </div>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
              <button type="button" class="btn-secondary filter-toggle-btn" data-target="projectFilters">Filters</button>
              <a href="/superadmin/dashboard/analytics/export/projects?<%= new URLSearchParams({date_from: dateFrom, date_to: dateTo, metric, limit: limit || 40, project_search: typeof projectFilters !== 'undefined' ? projectFilters.search || '' : '', project_country: typeof projectFilters !== 'undefined' ? projectFilters.country || '' : '', project_city: typeof projectFilters !== 'undefined' ? projectFilters.city || '' : '', project_min_price: typeof projectFilters !== 'undefined' && projectFilters.minPrice ? projectFilters.minPrice : '', project_max_price: typeof projectFilters !== 'undefined' && projectFilters.maxPrice ? projectFilters.maxPrice : ''}).toString() %>" class="btn-export" title="Export to CSV">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M8 2V10M8 10L5 7M8 10L11 7M2 12H14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Export CSV
              </a>
            </div>
          </div>
          <div class="section-filters" id="projectFilters" style="display: none;">
            <div class="filters-row">
              <div class="field">
                <label for="project_search">Search</label>
                <input type="text" id="project_search" name="project_search" placeholder="Search projects..." value="<%= typeof projectFilters !== 'undefined' && projectFilters.search ? projectFilters.search : '' %>" />
              </div>
              <div class="field">
                <label for="project_country">Country</label>
                <select id="project_country" name="project_country">
                  <option value="">All countries</option>
                  <option value="Cyprus" <%= typeof projectFilters !== 'undefined' && projectFilters.country === 'Cyprus' ? 'selected' : '' %>>Cyprus</option>
                  <option value="UAE" <%= typeof projectFilters !== 'undefined' && projectFilters.country === 'UAE' ? 'selected' : '' %>>UAE</option>
                  <option value="Germany" <%= typeof projectFilters !== 'undefined' && projectFilters.country === 'Germany' ? 'selected' : '' %>>Germany</option>
                </select>
              </div>
              <div class="field">
                <label for="project_city">City</label>
                <input type="text" id="project_city" name="project_city" placeholder="City name" value="<%= typeof projectFilters !== 'undefined' && projectFilters.city ? projectFilters.city : '' %>" />
              </div>
              <div class="field">
                <label for="project_min_price">Min Price</label>
                <input type="number" id="project_min_price" name="project_min_price" placeholder="0" value="<%= typeof projectFilters !== 'undefined' && projectFilters.minPrice ? projectFilters.minPrice : '' %>" />
              </div>
            </div>
            <div class="filters-row">
              <div class="field">
                <label for="project_max_price">Max Price</label>
                <input type="number" id="project_max_price" name="project_max_price" placeholder="No limit" value="<%= typeof projectFilters !== 'undefined' && projectFilters.maxPrice ? projectFilters.maxPrice : '' %>" />
              </div>
              <div class="field actions">
                <button type="submit" class="btn-primary">Apply Filters</button>
                <button type="button" class="btn-secondary" onclick="document.getElementById('projectFilters').style.display='none'">Cancel</button>
              </div>
            </div>
          </div>
          <% if (!topProjects.length) { %>
            <p class="empty-state">No project activity in this range.</p>
          <% } else { %>
            <div class="table-wrapper">
              <table class="analytics-table sortable-table" data-table="projects">
                <thead>
                  <tr>
                    <th class="sortable" data-column="title">Project <span class="sort-indicator"></span></th>
                    <th class="sortable" data-column="location">Location <span class="sort-indicator"></span></th>
                    <th class="sortable" data-column="views">Views <span class="sort-indicator"></span></th>
                    <th class="sortable" data-column="leads">Form submissions <span class="sort-indicator"></span></th>
                  </tr>
                </thead>
                <tbody>
                  <% topProjects.forEach(item => { %>
                    <tr data-title="<%= (item.title || '').toLowerCase() %>" data-location="<%= ((item.city || '') + ' ' + (item.country || '')).toLowerCase() %>" data-views="<%= item.total_views || 0 %>" data-leads="<%= item.total_leads || 0 %>">
                      <td>
                        <% if (item.slug) { %>
                          <a
                            href="/projects/<%= item.slug %>"
                            target="_blank"
                            rel="noopener"
                            class="table-link line-clamp"
                          ><%= item.title %></a>
                        <% } else { %>
                          <span class="line-clamp"><%= item.title %></span>
                        <% } %>
                      </td>
                      <td><%= item.city || '—' %>, <%= item.country || '—' %></td>
                      <td class="number"><%= (item.total_views || 0).toLocaleString() %></td>
                      <td class="number"><%= (item.total_leads || 0).toLocaleString() %></td>
                    </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
          <% } %>
        </div>
      </section>

      <section class="grid two-columns">
        <div class="panel">
          <div class="panel-header">
            <div>
              <h2>Top agents</h2>
              <p>Showing <%= agentPerformance.length %> agents</p>
            </div>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
              <button type="button" class="btn-secondary filter-toggle-btn" data-target="agentFilters">Filters</button>
              <a href="/superadmin/dashboard/analytics/export/agents?<%= new URLSearchParams({date_from: dateFrom, date_to: dateTo, metric, limit: limit || 40, agent_search: typeof agentFilters !== 'undefined' && agentFilters.search ? agentFilters.search : ''}).toString() %>" class="btn-export" title="Export to CSV">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M8 2V10M8 10L5 7M8 10L11 7M2 12H14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Export CSV
              </a>
            </div>
          </div>
          <div class="section-filters" id="agentFilters" style="display: none;">
            <div class="filters-row">
              <div class="field">
                <label for="agent_search">Search</label>
                <input type="text" id="agent_search" name="agent_search" placeholder="Search agents..." value="<%= typeof agentFilters !== 'undefined' && agentFilters.search ? agentFilters.search : '' %>" />
              </div>
              <div class="field actions">
                <button type="submit" class="btn-primary">Apply Filters</button>
                <button type="button" class="btn-secondary" onclick="document.getElementById('agentFilters').style.display='none'">Cancel</button>
              </div>
            </div>
          </div>
          <% if (!agentPerformance.length) { %>
            <p class="empty-state">No agent activity captured yet.</p>
          <% } else { %>
            <div class="table-wrapper">
              <table class="analytics-table sortable-table" data-table="agents">
                <thead>
                  <tr>
                    <th class="sortable" data-column="name">Agent <span class="sort-indicator"></span></th>
                    <th class="sortable" data-column="views">Views <span class="sort-indicator"></span></th>
                    <th class="sortable" data-column="leads">Form submissions <span class="sort-indicator"></span></th>
                  </tr>
                </thead>
                <tbody>
                  <% agentPerformance.forEach(agent => { %>
                    <tr data-name="<%= (agent.name || '').toLowerCase() %>" data-views="<%= agent.total_views || 0 %>" data-leads="<%= agent.total_form_submissions || 0 %>">
                      <td><%= agent.name || 'N/A' %></td>
                      <td class="number"><%= (agent.total_views || 0).toLocaleString() %></td>
                      <td class="number"><%= (agent.total_form_submissions || 0).toLocaleString() %></td>
                    </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
          <% } %>
        </div>
        <div class="panel">
          <div class="panel-header">
            <h2>Top pages</h2>
          </div>
          <% if (!topPages.length) { %>
            <p class="empty-state">No page views recorded yet.</p>
          <% } else { %>
            <table class="analytics-table">
              <thead>
                <tr>
                  <th>Page</th>
                  <th>Visits</th>
                </tr>
              </thead>
              <tbody>
                <% topPages.forEach(page => { %>
                  <tr>
                    <td><span class="line-clamp"><%= page.path || '/' %></span></td>
                    <td class="number"><%= (page.views || 0).toLocaleString() %></td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          <% } %>
        </div>
      </section>

      <section class="grid two-columns">
        <div class="panel">
          <div class="panel-header">
            <h2>Hot locations</h2>
          </div>
          <% if (!locationInsights.length) { %>
            <p class="empty-state">No location activity yet.</p>
          <% } else { %>
            <table class="analytics-table">
              <thead>
                <tr>
                  <th>Location</th>
                  <th>Views</th>
                  <th>Leads</th>
                </tr>
              </thead>
              <tbody>
                <% locationInsights.forEach(row => { %>
                  <tr>
                    <td><%= (row.city || '—') %>, <%= row.country || '' %></td>
                    <td class="number"><%= (row.total_views || 0).toLocaleString() %></td>
                    <td class="number"><%= (row.total_leads || 0).toLocaleString() %></td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          <% } %>
        </div>

        <div class="panel">
          <div class="panel-header">
            <h2>Latest leads</h2>
          </div>
          <% if (!recentLeads.length) { %>
            <p class="empty-state">No leads captured in this period.</p>
          <% } else { %>
            <table class="analytics-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Interest</th>
                  <th>Source</th>
                  <th>Created</th>
                </tr>
              </thead>
              <tbody>
                <% recentLeads.forEach(lead => { %>
                  <tr>
                    <td><%= lead.name || 'Anonymous' %></td>
                    <td>
                      <% if (lead.property_title) { %>
                        <span>Property: <%= lead.property_title %></span>
                      <% } else if (lead.project_title) { %>
                        <span>Project: <%= lead.project_title %></span>
                      <% } else { %>
                        <span>General inquiry</span>
                      <% } %>
                    </td>
                    <td><%= (lead.source || 'contact_form').replace('_', ' ') %></td>
                    <td><%= new Date(lead.created_at).toLocaleString() %></td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          <% } %>
        </div>
      </section>
    </main>
  </div>
</div>

<script src="/vendor/chartjs/chart.umd.js" defer></script>
<script src="/js/superadmin/analytics-dashboard.js?v=<%= assetVersion %>" defer></script>
