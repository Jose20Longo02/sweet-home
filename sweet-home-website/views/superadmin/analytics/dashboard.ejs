<head>
  <link rel="stylesheet" href="/css/superadmin/analytics.css?v=<%= assetVersion %>" />
</head>

<% title = 'Analytics' %>

<div class="admin-panel analytics-page"
  data-time-series='<%- JSON.stringify(timeSeries || []).replace(/'/g, '&#39;') %>'
  data-quick-range="<%= typeof quickRange !== 'undefined' ? quickRange : '' %>">
  <div class="admin-body">
    <%- include('../../partials/superadmin-sidebar', {
      activePage: 'analytics',
      pendingCount
    }) %>

    <main class="admin-content">
      <header class="analytics-header">
        <div>
          <h1>Performance Analytics</h1>
          <p class="subtitle">Track traffic, engagement, and lead activity across the site</p>
        </div>
        <span class="metric-pill">Ranking by <strong><%= metric === 'forms' ? 'Form Submissions' : 'Views' %></strong></span>
      </header>

      <section class="filters-card">
        <form method="GET" action="/superadmin/dashboard/analytics" class="filters-form" id="analyticsFilterForm">
          <div class="filters-row">
            <div class="field">
              <label for="date_from">From</label>
              <input type="date" id="date_from" name="date_from" value="<%= dateFrom %>" required />
            </div>
            <div class="field">
              <label for="date_to">To</label>
              <input type="date" id="date_to" name="date_to" value="<%= dateTo %>" required />
            </div>
            <div class="field">
              <label for="metric">Rank By</label>
              <select id="metric" name="metric">
                <option value="views" <%= metric === 'views' ? 'selected' : '' %>>Views</option>
                <option value="forms" <%= metric === 'forms' ? 'selected' : '' %>>Form submissions</option>
              </select>
            </div>
            <div class="field actions">
              <button type="submit" class="btn-primary">Apply</button>
              <a class="btn-secondary" href="/superadmin/dashboard/analytics">Reset</a>
            </div>
          </div>
          <div class="quick-ranges">
            <span>Quick ranges:</span>
            <button type="submit" name="quick_range" value="today" data-range="today" class="<%= quickRange === 'today' ? 'active' : '' %>">Today</button>
            <button type="submit" name="quick_range" value="7" data-range="7" class="<%= quickRange === '7' ? 'active' : '' %>">Last 7 days</button>
            <button type="submit" name="quick_range" value="30" data-range="30" class="<%= quickRange === '30' ? 'active' : '' %>">Last 30 days</button>
            <button type="submit" name="quick_range" value="90" data-range="90" class="<%= quickRange === '90' ? 'active' : '' %>">Last 90 days</button>
            <button type="submit" name="quick_range" value="365" data-range="365" class="<%= quickRange === '365' ? 'active' : '' %>">Last 12 months</button>
            <button type="submit" name="quick_range" value="ytd" data-range="ytd" class="<%= quickRange === 'ytd' ? 'active' : '' %>">Year to date</button>
          </div>
        </form>
      </section>

      <section class="summary-grid">
        <div class="summary-card">
          <p class="label">Total visits</p>
          <p class="value"><%= (summary.total_visits || 0).toLocaleString() %></p>
        </div>
        <div class="summary-card">
          <p class="label">Property views</p>
          <p class="value"><%= (summary.property_views || 0).toLocaleString() %></p>
        </div>
        <div class="summary-card">
          <p class="label">Project views</p>
          <p class="value"><%= (summary.project_views || 0).toLocaleString() %></p>
        </div>
        <div class="summary-card">
          <p class="label">Form submissions</p>
          <p class="value"><%= (summary.form_submissions || 0).toLocaleString() %></p>
        </div>
      </section>

      <section class="panel">
        <div class="panel-header">
          <div>
            <h2>Traffic overview</h2>
            <p>Daily breakdown of visits, property interest, and leads</p>
          </div>
        </div>
        <div class="chart-container" style="position: relative; height: 300px; margin-top: 1rem;">
          <canvas id="trafficChart" style="display: none;"></canvas>
          <div id="chartLoading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #64748b; font-size: 14px; text-align: center;">Loading chart...</div>
          <div id="chartError" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #64748b; font-size: 14px; text-align: center; padding: 1rem;"></div>
        </div>
      </section>

      <section class="grid two-columns">
        <div class="panel">
          <div class="panel-header">
            <h2>Top properties (<%= metric === 'forms' ? 'Leads' : 'Views' %>)</h2>
          </div>
          <% if (!topProperties.length) { %>
            <p class="empty-state">No property activity in this range.</p>
          <% } else { %>
            <table class="analytics-table">
              <thead>
                <tr>
                  <th>Property</th>
                  <th>Location</th>
                  <th>Views</th>
                  <th>Form submissions</th>
                </tr>
              </thead>
              <tbody>
                <% topProperties.forEach(item => { %>
                  <tr>
                    <td>
                      <% if (item.slug) { %>
                        <a
                          href="/properties/<%= item.slug %>"
                          target="_blank"
                          rel="noopener"
                          class="table-link line-clamp"
                        ><%= item.title %></a>
                      <% } else { %>
                        <span class="line-clamp"><%= item.title %></span>
                      <% } %>
                    </td>
                    <td><%= item.city || '—' %>, <%= item.country || '—' %></td>
                    <td class="number"><%= (item.total_views || 0).toLocaleString() %></td>
                    <td class="number"><%= (item.total_leads || 0).toLocaleString() %></td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          <% } %>
        </div>

        <div class="panel">
          <div class="panel-header">
            <h2>Top projects (<%= metric === 'forms' ? 'Leads' : 'Views' %>)</h2>
          </div>
          <% if (!topProjects.length) { %>
            <p class="empty-state">No project activity in this range.</p>
          <% } else { %>
            <table class="analytics-table">
              <thead>
                <tr>
                  <th>Project</th>
                  <th>Location</th>
                  <th>Views</th>
                  <th>Form submissions</th>
                </tr>
              </thead>
              <tbody>
                <% topProjects.forEach(item => { %>
                  <tr>
                    <td>
                      <% if (item.slug) { %>
                        <a
                          href="/projects/<%= item.slug %>"
                          target="_blank"
                          rel="noopener"
                          class="table-link line-clamp"
                        ><%= item.title %></a>
                      <% } else { %>
                        <span class="line-clamp"><%= item.title %></span>
                      <% } %>
                    </td>
                    <td><%= item.city || '—' %>, <%= item.country || '—' %></td>
                    <td class="number"><%= (item.total_views || 0).toLocaleString() %></td>
                    <td class="number"><%= (item.total_leads || 0).toLocaleString() %></td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          <% } %>
        </div>
      </section>

      <section class="grid two-columns">
        <div class="panel">
          <div class="panel-header">
            <h2>Top agents</h2>
          </div>
          <% if (!agentPerformance.length) { %>
            <p class="empty-state">No agent activity captured yet.</p>
          <% } else { %>
            <table class="analytics-table">
              <thead>
                <tr>
                  <th>Agent</th>
                  <th>Views</th>
                  <th>Form submissions</th>
                </tr>
              </thead>
              <tbody>
                <% agentPerformance.forEach(agent => { %>
                  <tr>
                    <td><%= agent.name || 'N/A' %></td>
                    <td class="number"><%= (agent.total_views || 0).toLocaleString() %></td>
                    <td class="number"><%= (agent.total_form_submissions || 0).toLocaleString() %></td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          <% } %>
        </div>
        <div class="panel">
          <div class="panel-header">
            <h2>Top pages</h2>
          </div>
          <% if (!topPages.length) { %>
            <p class="empty-state">No page views recorded yet.</p>
          <% } else { %>
            <table class="analytics-table">
              <thead>
                <tr>
                  <th>Page</th>
                  <th>Visits</th>
                </tr>
              </thead>
              <tbody>
                <% topPages.forEach(page => { %>
                  <tr>
                    <td><span class="line-clamp"><%= page.path || '/' %></span></td>
                    <td class="number"><%= (page.views || 0).toLocaleString() %></td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          <% } %>
        </div>
      </section>

      <section class="grid two-columns">
        <div class="panel">
          <div class="panel-header">
            <h2>Hot locations</h2>
          </div>
          <% if (!locationInsights.length) { %>
            <p class="empty-state">No location activity yet.</p>
          <% } else { %>
            <table class="analytics-table">
              <thead>
                <tr>
                  <th>Location</th>
                  <th>Views</th>
                  <th>Leads</th>
                </tr>
              </thead>
              <tbody>
                <% locationInsights.forEach(row => { %>
                  <tr>
                    <td><%= (row.city || '—') %>, <%= row.country || '' %></td>
                    <td class="number"><%= (row.total_views || 0).toLocaleString() %></td>
                    <td class="number"><%= (row.total_leads || 0).toLocaleString() %></td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          <% } %>
        </div>

        <div class="panel">
          <div class="panel-header">
            <h2>Latest leads</h2>
          </div>
          <% if (!recentLeads.length) { %>
            <p class="empty-state">No leads captured in this period.</p>
          <% } else { %>
            <table class="analytics-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Interest</th>
                  <th>Source</th>
                  <th>Created</th>
                </tr>
              </thead>
              <tbody>
                <% recentLeads.forEach(lead => { %>
                  <tr>
                    <td><%= lead.name || 'Anonymous' %></td>
                    <td>
                      <% if (lead.property_title) { %>
                        <span>Property: <%= lead.property_title %></span>
                      <% } else if (lead.project_title) { %>
                        <span>Project: <%= lead.project_title %></span>
                      <% } else { %>
                        <span>General inquiry</span>
                      <% } %>
                    </td>
                    <td><%= (lead.source || 'contact_form').replace('_', ' ') %></td>
                    <td><%= new Date(lead.created_at).toLocaleString() %></td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          <% } %>
        </div>
      </section>
    </main>
  </div>
</div>

<script src="/vendor/chartjs/chart.umd.js" defer></script>
<script src="/js/superadmin/analytics-dashboard.js?v=<%= assetVersion %>" defer></script>
