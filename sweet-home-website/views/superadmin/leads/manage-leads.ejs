<% title = 'All Leads'; %>
<link rel="stylesheet" href="/css/superadmin/leads.css" />

<div class="admin-panel">
  <div class="admin-body">
    <!-- Sidebar -->
    <%- include('../../partials/superadmin-sidebar', { activePage: 'leads', pendingCount: typeof pendingCount !== 'undefined' ? pendingCount : 0 }) %>

    <!-- Main content -->
    <main class="admin-content">
  <header class="np-header">
    <div class="left">
      <h1>All Leads</h1>
      <p class="subtitle">All inquiries across all properties</p>
    </div>
    <div class="right">
      <button id="exportLeadsBtn" class="btn btn-primary" style="margin-right: 10px;">üì• Export Leads</button>
      <a href="/superadmin/dashboard" class="btn btn-light">‚Üê Return to dashboard</a>
    </div>
  </header>

  <section class="card" style="margin-top: 1rem;">
    <form method="get" class="filters-grid">
      <input type="text" name="q" placeholder="Search name/email/phone/message" value="<%= filters.q || '' %>" />
      <select name="status">
        <option value="">All Statuses</option>
        <% ['New','Contacted','Interested','Not Interested','Closed'].forEach(s => { %>
          <option value="<%= s %>" <%= filters.status === s ? 'selected' : '' %>><%= s %></option>
        <% }) %>
      </select>
      <select name="leadKind">
        <option value="">All Lead Kinds</option>
        <option value="buyer" <%= filters.leadKind === 'buyer' ? 'selected' : '' %>>Buyer leads (property/project)</option>
        <option value="seller" <%= filters.leadKind === 'seller' ? 'selected' : '' %>>Seller leads (owners form)</option>
        <option value="unknown" <%= filters.leadKind === 'unknown' ? 'selected' : '' %>>Unknown (general forms)</option>
      </select>
      <select name="leadType">
        <option value="">All Relation Types</option>
        <option value="property" <%= filters.leadType === 'property' ? 'selected' : '' %>>Only property leads</option>
        <option value="project" <%= filters.leadType === 'project' ? 'selected' : '' %>>Only project leads</option>
      </select>
      <input type="date" name="from" value="<%= filters.from || '' %>" />
      <input type="date" name="to" value="<%= filters.to || '' %>" />
      <select name="agentId">
        <option value="">All Agents</option>
        <option value="unassigned" <%= filters.agentId === 'unassigned' ? 'selected' : '' %>>Unassigned</option>
        <% if (typeof allAgents !== 'undefined' && Array.isArray(allAgents)) { %>
          <% allAgents.forEach(agent => { %>
            <option value="<%= agent.id %>" <%= filters.agentId && parseInt(filters.agentId) === agent.id ? 'selected' : '' %>><%= agent.name %></option>
          <% }) %>
        <% } %>
      </select>
      <input type="number" name="propertyId" placeholder="Property ID" value="<%= filters.propertyId || '' %>" />
      <input type="number" name="projectId" placeholder="Project ID" value="<%= filters.projectId || '' %>" />
      <button class="btn btn-primary" type="submit">Filter</button>
    </form>
  </section>

  <section class="card" style="margin-top: 1rem;">
    <div class="table-responsive">
      <table class="table">
        <thead>
          <tr>
            <th>Created</th>
            <th>Property</th>
            <th>Project</th>
            <th>Location</th>
            <th>Agent</th>
            <th>Lead</th>
            <th>Message</th>
            <th>Language</th>
            <th>Status</th>
            <th>Last Contact</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% if (!leads || leads.length === 0) { %>
            <tr><td colspan="10" style="text-align:center;">No leads found</td></tr>
          <% } %>
          <% leads.forEach(lead => { %>
            <tr>
              <td data-label="Created"><%= new Date(lead.created_at).toLocaleString() %></td>
              <td data-label="Property">
                <% if (lead.property_id && lead.property_title && lead.property_slug) { %>
                  <div><a href="/properties/<%= lead.property_slug %>" target="_blank"><%= lead.property_title %></a></div>
                <% } else if (!lead.property_id && !lead.project_id) { %>
                  <div class="lead-source">
                    <% 
                      let sourceText = '';
                      switch(lead.source) {
                        case 'seller_form':
                          sourceText = 'Sellers Form';
                          break;
                        case 'contact_form':
                          sourceText = 'General Contact Form';
                          break;
                        case 'property_form':
                          sourceText = 'Property Form';
                          break;
                        case 'project_form':
                          sourceText = 'Project Form';
                          break;
                        default:
                          sourceText = lead.source || 'Unknown';
                      }
                    %>
                    <span class="source-badge"><%= sourceText %></span>
                  </div>
                <% } else { %>
                  <div>-</div>
                <% } %>
              </td>
              <td data-label="Project">
                <% if (lead.project_id && lead.project_title && lead.project_slug) { %>
                  <div><a href="/projects/<%= lead.project_slug %>" target="_blank"><%= lead.project_title %></a></div>
                <% } else { %>
                  <div>-</div>
                <% } %>
              </td>
              <td data-label="Location">
                <% 
                  let location = '';
                  if (lead.property_id && (lead.property_neighborhood || lead.property_city)) {
                    location = `${lead.property_neighborhood || lead.property_city}, ${lead.property_city || lead.property_country}`;
                  } else if (lead.project_id && (lead.project_neighborhood || lead.project_city)) {
                    location = `${lead.project_neighborhood || lead.project_city}, ${lead.project_city || lead.project_country}`;
                  }
                %>
                <div><%= location || '-' %></div>
              </td>
              <td data-label="Agent">
                <div>
                  <select class="lead-agent" data-lead-id="<%= lead.id %>">
                    <option value="" <%= !lead.agent_id ? 'selected' : '' %>>Unassigned</option>
                    <% if (typeof allAgents !== 'undefined' && Array.isArray(allAgents)) { %>
                      <% allAgents.forEach(function(a){ %>
                        <option value="<%= a.id %>" <%= (lead.agent_id === a.id ? 'selected' : '') %>><%= a.name %> (#<%= a.id %>)</option>
                      <% }) %>
                    <% } %>
                  </select>
                </div>
              </td>
              <td data-label="Lead">
                <div><strong><%= lead.name %></strong></div>
                <div><a href="mailto:<%= lead.email %>"><%= lead.email %></a></div>
                <% if (lead.phone) { %><div><a href="tel:<%= lead.phone %>"><%= lead.phone %></a></div><% } %>
              </td>
              <td data-label="Message">
                <% if (lead.message && lead.message.trim()) { %>
                  <button class="btn btn-primary btn-sm" data-show-message="<%= lead.id %>" data-message="<%= encodeURIComponent(lead.message) %>">
                    See message
                  </button>
                <% } else { %>
                  <span style="color: var(--gray-500);">-</span>
                <% } %>
              </td>
              <td data-label="Language"><%= lead.preferred_language ? String(lead.preferred_language).toUpperCase() : '-' %></td>
              <td data-label="Status">
                <select data-lead-id="<%= lead.id %>" class="lead-status">
                  <% ['New','Contacted','Interested','Not Interested','Closed'].forEach(s => { %>
                    <option value="<%= s %>" <%= lead.status === s ? 'selected' : '' %>><%= s %></option>
                  <% }) %>
                </select>
              </td>
              <td data-label="Last Contact">
                <input type="datetime-local" data-lead-id="<%= lead.id %>" class="lead-last-contact" value="<%= lead.last_contact_at ? new Date(lead.last_contact_at).toISOString().slice(0,16) : '' %>" />
              </td>
              <td data-label="Actions">
                <button class="btn btn-light" data-toggle-notes="<%= lead.id %>">
                  Notes <span class="notes-count" data-notes-count-for="<%= lead.id %>"><%= (lead.internal_notes ? (String(lead.internal_notes).split(/\n\n+/).filter(Boolean).length) : 0) %></span>
                </button>
                <button class="btn btn-outline" data-delete-lead="<%= lead.id %>">Delete</button>
              </td>
            </tr>
            <tr id="notes-<%= lead.id %>" class="notes-row" style="display:none;">
              <td colspan="11">
                <% const _notesArr = (lead.internal_notes ? String(lead.internal_notes).split(/\n\n+/).filter(Boolean) : []); %>
                <ul class="lead-notes-list" data-notes-list-for="<%= lead.id %>" style="padding-left:18px; margin:0 0 10px 0;">
                  <% _notesArr.forEach(function(n){
                       var m = n.match(/^(.*)\s*\(by\s+(.+?)\s+on\s+([^)]+)\)$/);
                       var body = m ? m[1] : n;
                       var who  = m ? m[2] : '';
                       var when = m ? m[3] : '';
                  %>
                    <li style="margin-bottom:6px;">
                      <div><%= body %></div>
                      <div style="font-size:12px;color:var(--gray-600);"><%= who ? ('by ' + who) : '' %><%= when ? (' ‚Ä¢ ' + when) : '' %></div>
                    </li>
                  <% }); %>
                </ul>
                <textarea rows="3" style="width:100%;" data-lead-id="<%= lead.id %>" class="lead-new-note" placeholder="Add a new note..."></textarea>
                <div style="margin-top: .5rem; text-align: right;">
                  <button class="btn btn-primary" data-save="<%= lead.id %>">Save</button>
                </div>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </section>
    </main>
  </div>
</div>

<!-- Message Modal -->
<div id="messageModal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Client Message</h3>
      <button class="modal-close" id="messageModalClose">&times;</button>
    </div>
    <div class="modal-body">
      <div id="messageContent" style="white-space: pre-wrap; line-height: 1.5;"></div>
    </div>
  </div>
</div>

<!-- Export Modal -->
<div id="exportModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
  <div class="modal-content" style="background: white; padding: 2rem; border-radius: 8px; max-width: 400px; width: 90%;">
    <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
      <h3 style="margin: 0;">Export Leads</h3>
      <button class="modal-close" id="exportModalClose" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
    </div>
    <div class="modal-body">
      <p style="margin-bottom: 1rem;">Choose the export format:</p>
      <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
        <button id="exportCsvBtn" class="btn btn-primary" style="flex: 1;">üìÑ Export as CSV</button>
        <button id="exportExcelBtn" class="btn btn-primary" style="flex: 1;">üìä Export as Excel</button>
      </div>
      <p style="font-size: 0.9rem; color: #666; margin: 0;">The export will include all leads matching your current filters.</p>
    </div>
  </div>
</div>

<script src="/js/superadmin-leads.js?v=2" defer></script>
<script>
  // Export functionality
  (function() {
    const exportBtn = document.getElementById('exportLeadsBtn');
    const exportModal = document.getElementById('exportModal');
    const exportModalClose = document.getElementById('exportModalClose');
    const exportCsvBtn = document.getElementById('exportCsvBtn');
    const exportExcelBtn = document.getElementById('exportExcelBtn');

    if (!exportBtn) return;

    // Get current filter parameters from URL
    function getFilterParams() {
      const urlParams = new URLSearchParams(window.location.search);
      const params = new URLSearchParams();
      
      // Copy all filter parameters
      ['q', 'status', 'from', 'to', 'agentId', 'propertyId', 'projectId', 'leadType', 'leadKind'].forEach(key => {
        const value = urlParams.get(key);
        if (value) params.set(key, value);
      });
      
      return params.toString();
    }

    // Open export modal
    exportBtn.addEventListener('click', function() {
      exportModal.style.display = 'flex';
    });

    // Close export modal
    exportModalClose.addEventListener('click', function() {
      exportModal.style.display = 'none';
    });

    // Close modal when clicking outside
    exportModal.addEventListener('click', function(e) {
      if (e.target === exportModal) {
        exportModal.style.display = 'none';
      }
    });

    // Export as CSV
    exportCsvBtn.addEventListener('click', function() {
      const filterParams = getFilterParams();
      const url = '/superadmin/dashboard/leads/export?format=csv' + (filterParams ? '&' + filterParams : '');
      window.location.href = url;
      exportModal.style.display = 'none';
    });

    // Export as Excel
    exportExcelBtn.addEventListener('click', function() {
      const filterParams = getFilterParams();
      const url = '/superadmin/dashboard/leads/export?format=excel' + (filterParams ? '&' + filterParams : '');
      window.location.href = url;
      exportModal.style.display = 'none';
    });
  })();
</script>


