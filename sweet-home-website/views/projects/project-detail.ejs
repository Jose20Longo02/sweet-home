<% title = project.title; hideFooter = false; headPartial = '../partials/seo/project-detail-head'; %>
<link rel="stylesheet" href="/css/project-detail.css" />
<% if (process.env.RECAPTCHA_SITE_KEY) { %>
<script src="https://www.google.com/recaptcha/api.js?render=<%= process.env.RECAPTCHA_SITE_KEY %>"></script>
<% } %>

<div class="project-detail-page">
  <!-- Project Header -->
  <section class="project-header">
    <div class="container">
      <nav class="breadcrumb">
        <a href="/projects"><%= t('nav.projects','Projects') %></a>
        <span class="separator">/</span>
        <a href="/projects?country=<%= project.country %>"><%= project.country %></a>
        <span class="separator">/</span>
        <a href="/projects?country=<%= project.country %>&city=<%= project.city %>"><%= project.city %></a>
        <span class="separator">/</span>
        <span class="current"><%= project.title %></span>
      </nav>
      
      <div class="project-header-content">
        <div class="project-badges">
          <span class="badge badge-type"><%= project.type || t('projects.detail.defaultType','Development') %></span>
          <% if (project.status) { %>
            <span class="badge badge-status badge-<%= project.status %>"><%= project.status %></span>
          <% } %>
        </div>
        
        <h1 class="project-title"><%= project.title %></h1>
        
        <div class="project-location">
          <span class="icon icon-16 icon-inline icon-mask icon-location" style="color: #fff;"></span>
          <span><%= project.city %>, <%= project.country %></span>
          <% if (project.neighborhood) { %>
            <span class="neighborhood">• <%= project.neighborhood %></span>
          <% } %>
        </div>
        
        <div class="project-meta">
          <% if (project.total_units) { %>
            <div class="meta-item">
              <i class="fas fa-building"></i>
              <span><%= project.total_units %> <%= t('projects.detail.units','Units') %></span>
            </div>
          <% } %>
          
          <% if (project.completion_date) { %>
            <div class="meta-item">
              <i class="fas fa-calendar"></i>
              <span><%= t('projects.list.completion','Completion') %>: <%= project.completion_date %></span>
            </div>
          <% } %>
          
          <% if (project.price_range) { %>
            <div class="meta-item">
              <i class="fas fa-dollar-sign"></i>
              <span><%= project.price_range %></span>
            </div>
          <% } %>
        </div>
      </div>
    </div>
  </section>

  <!-- Project Content -->
  <section class="project-content">
    <div class="container">
      <div class="project-layout">
        <!-- Main Content -->
        <div class="project-main">
          <!-- Project Gallery -->
          <div class="project-gallery">
            <% if ((project.photos && project.photos.length > 0) || project.video_url) { %>
              <div class="gallery-main">
                <% if (project.video_url) { %>
                  <video id="mainVideo" controls style="width:100%; height:100%; object-fit:contain; background:#000; pointer-events:auto;" playsinline>
                    <source src="<%= project.video_url %>" type="video/mp4">
                  </video>
                  <button class="video-play-overlay" type="button" aria-label="Play video">
                    <svg viewBox="0 0 64 64" width="64" height="64" aria-hidden="true">
                      <circle cx="32" cy="32" r="31" fill="rgba(0,0,0,0.6)" stroke="white" stroke-width="2" />
                      <polygon points="26,20 26,44 46,32" fill="white" />
                    </svg>
                  </button>
                <% } else { %>
                  <% const first = project.photos[0];
                     const dot = first.lastIndexOf('.');
                     const base = dot > -1 ? first.slice(0, dot) : first; %>
                  <% if (project.has_main_variants && project.main_variant_base) { %>
                    <picture>
                      <source srcset="<%= project.main_variant_base %>-640.avif 640w, <%= project.main_variant_base %>-960.avif 960w, <%= project.main_variant_base %>-1280.avif 1280w, <%= project.main_variant_base %>-1920.avif 1920w" type="image/avif">
                      <source srcset="<%= project.main_variant_base %>-640.webp 640w, <%= project.main_variant_base %>-960.webp 960w, <%= project.main_variant_base %>-1280.webp 1280w, <%= project.main_variant_base %>-1920.webp 1920w" type="image/webp">
                      <img src="<%= first %>" alt="<%= project.title %>"
                           id="main-image" class="main-image"
                           srcset="<%= project.main_variant_base %>-640.jpg 640w, <%= project.main_variant_base %>-960.jpg 960w, <%= project.main_variant_base %>-1280.jpg 1280w, <%= project.main_variant_base %>-1920.jpg 1920w"
                           sizes="(max-width: 768px) 100vw, 960px"
                           decoding="async"
                           onerror="this.onerror=null; this.src='/img/property-placeholder.jpg'; this.style.opacity='0.5';">
                    </picture>
                  <% } else { %>
                    <img src="<%= first %>" alt="<%= project.title %>" id="main-image" class="main-image" decoding="async" onerror="this.onerror=null; this.src='/img/property-placeholder.jpg'; this.style.opacity='0.5';">
                  <% } %>
                <% } %>
                <div class="photo-overlay">
                  <button class="gallery-nav prev" aria-label="<%= t('common.previous','Previous') %> image">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="15,18 9,12 15,6"></polyline>
                    </svg>
                  </button>
                  <button class="gallery-nav next" aria-label="<%= t('common.next','Next') %> image">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="9,18 15,12 9,6"></polyline>
                    </svg>
                  </button>
                </div>
              </div>

              <% if ((project.photos && project.photos.length > 0) || project.video_url) { %>
                <div class="gallery-thumbnails">
                  <% if (project.video_url) { %>
                    <div class="thumbnail video-thumb active" data-type="video" data-index="0" data-video-url="<%= project.video_url %>">
                      <img src="<%= (project.photos && project.photos[0]) ? project.photos[0] : '/img/property-placeholder.jpg' %>" alt="<%= project.title %> - Video" loading="lazy" decoding="async" onerror="this.onerror=null; this.src='/img/property-placeholder.jpg'; this.style.opacity='0.5';">
                      <span class="play-badge" aria-hidden="true">
                        <svg viewBox="0 0 36 36" width="28" height="28">
                          <circle cx="18" cy="18" r="17" fill="rgba(0,0,0,0.55)" stroke="white" stroke-width="1.5" />
                          <polygon points="14,10 14,26 26,18" fill="white" />
                        </svg>
                      </span>
                    </div>
                  <% } %>
                  <% (project.photos || []).forEach((photo, index) => { %>
                    <% const offset = project.video_url ? 1 : 0; %>
                    <div class="thumbnail <%= (!project.video_url && index === 0) ? 'active' : '' %>" 
                         data-type="image"
                         data-photo="<%= photo %>"
                         data-index="<%= index + offset %>">
                      <img src="<%= photo %>" alt="<%= project.title %> - Image <%= index + 1 %>" loading="lazy" decoding="async" onerror="this.onerror=null; this.src='/img/property-placeholder.jpg'; this.style.opacity='0.5';">
                    </div>
                  <% }) %>
                </div>
              <% } %>
            <% } else { %>
              <div class="gallery-placeholder">
                <i class="fas fa-image"></i>
                <p><%= t('projects.detail.noImages','No images available') %></p>
              </div>
            <% } %>
          </div>

          <div class="brochure-wrap">
            <button type="button" class="btn btn-primary btn-block js-download-expose" style="margin-bottom: 10px;" data-slug="<%= project.slug %>" data-type="project">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7,10 12,15 17,10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
              </svg>
              <%= t('common.downloadExpose','Download Expose') || 'Download Expose' %>
            </button>
            <% if (project.brochure_url) { %>
              <a href="<%= project.brochure_url %>" target="_blank" rel="noopener" class="btn btn-brochure btn-block">
                <i class="fas fa-file-pdf"></i>
                Open Brochure
              </a>
            <% } %>
          </div>

          <!-- Project Description -->
          <div class="project-section">
            <h2><%= t('projects.detail.overview','Project Overview') %></h2>
            <div class="project-description">
              <div class="project-description-text"><%- project.description.replace(/\n/g, '<br>') %></div>
            </div>
          </div>

          <!-- Project Features -->
          <% if (project.features && project.features.length > 0) { %>
            <div class="project-section">
              <h2><%= t('projects.detail.keyFeatures','Key Features') %></h2>
              <div class="features-grid">
                <% project.features.forEach(feature => { %>
                  <div class="feature-item">
                    <i class="fas fa-check"></i>
                    <span><%= feature %></span>
                  </div>
                <% }) %>
              </div>
            </div>
          <% } %>

          <!-- Project Amenities -->
          <% if (project.amenities && project.amenities.length > 0) { %>
            <div class="project-section">
              <h2><%= t('projects.detail.amenities','Amenities') %></h2>
              <div class="amenities-grid">
                <% project.amenities.forEach(amenity => { %>
                  <div class="amenity-item">
                    <i class="fas fa-star"></i>
                    <span><%= amenity %></span>
                  </div>
                <% }) %>
              </div>
            </div>
          <% } %>

          <!-- Project Properties -->
          <% if (projectProperties && projectProperties.length > 0) { %>
            <div class="project-section project-properties-section">
              <div class="project-properties-header">
                <h2>
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9,22 9,12 15,12 15,22"></polyline>
                  </svg>
                  <%= t('projects.detail.properties','Properties in this Project') %>
                </h2>
                <p class="project-properties-subtitle">
                  <%= projectProperties.length %> <%= projectProperties.length === 1 ? t('projects.detail.property', 'property') : t('projects.detail.propertiesCount', 'properties') %> <%= t('projects.detail.available', 'available') %>
                </p>
              </div>
              
              <div class="project-properties-grid">
                <% projectProperties.forEach(property => { %>
                  <div class="project-property-card">
                    <a href="/properties/<%= property.slug %>" class="property-card-link">
                      <div class="property-image-container">
                        <% if (property.photos && property.photos.length > 0) { %>
                          <img 
                            src="<%= property.photos[0] %>" 
                            alt="<%= property.title %>" 
                            loading="lazy"
                            decoding="async"
                            class="property-image"
                          >
                        <% } else { %>
                          <div class="property-image-placeholder">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                              <circle cx="8.5" cy="8.5" r="1.5"></circle>
                              <polyline points="21,15 16,10 5,21"></polyline>
                            </svg>
                          </div>
                        <% } %>
                        <div class="property-type-badge">
                          <%= property.type %>
                        </div>
                      </div>
                      
                      <div class="property-card-content">
                        <h3 class="property-title"><%= property.title %></h3>
                        
                        <div class="property-details">
                          <% if (property.price) { %>
                            <div class="property-price">
                              €<%= Number(property.price).toLocaleString() %>
                              <% if (property.rental_income) { %>
                                <span class="rental-income">| Rental: €<%= Number(property.rental_income).toLocaleString() %></span>
                              <% } %>
                            </div>
                          <% } %>
                          
                          <div class="property-meta">
                            <% if (property.rooms) { %>
                              <div class="meta-item">
                                <span class="icon icon-16 icon-inline icon-mask icon-bed" style="color: currentColor;"></span>
                                <%= property.rooms %> <%= t('properties.list.meta.rooms', 'rooms') %>
                              </div>
                            <% } %>
                            
                            <% if (property.bathrooms) { %>
                              <div class="meta-item">
                                <span class="icon icon-16 icon-inline icon-mask icon-bath" style="color: currentColor;"></span>
                                <%= property.bathrooms %> <%= t('properties.list.meta.baths', 'baths') %>
                              </div>
                            <% } %>
                            
                            <% if (property.size) { %>
                              <div class="meta-item">
                                <span class="icon icon-16 icon-inline icon-mask icon-size" style="color: currentColor;"></span>
                                <%= property.size %> <%= t('properties.list.meta.sqm', 'm²') %>
                              </div>
                            <% } %>
                          </div>
                        </div>
                      </div>
                    </a>
                  </div>
                <% }) %>
              </div>
              
              <% if (projectProperties.length >= 12) { %>
                <div class="project-properties-footer">
                  <a href="/properties?project=<%= project.id %>" class="btn btn-outline">
                    <%= t('projects.detail.viewAllProperties', 'View All Properties') %>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <polyline points="9,18 15,12 9,6"></polyline>
                    </svg>
                  </a>
                </div>
              <% } %>
            </div>
          <% } %>

          <!-- Project Specifications -->
          <% if (project.specifications && Object.keys(project.specifications).length > 0) { %>
            <div class="project-section">
              <h2><%= t('projects.detail.specifications','Specifications') %></h2>
              <div class="specifications-table">
                <% Object.entries(project.specifications).forEach(([key, value]) => { %>
                  <div class="spec-row">
                    <div class="spec-label"><%= key %></div>
                    <div class="spec-value"><%= value %></div>
                  </div>
                <% }) %>
              </div>
            </div>
          <% } %>

          <!-- Location Details -->
          <% if (project.location_details) { %>
            <div class="project-section">
              <h2><%= t('projects.detail.locationDetails','Location Details') %></h2>
              <div class="location-details">
                <p><%= project.location_details %></p>
              </div>
            </div>
          <% } %>
        </div>

        <!-- Sidebar -->
        <div class="project-sidebar" data-project-id="<%= project.id %>">
          <!-- Contact Form -->
          <div class="contact-card" id="projectContactCard">
            <h3><%= t('projects.detail.interested','Interested in this project?') %></h3>
            <p><%= t('projects.detail.getInTouch','Get in touch with our team for more information') %></p>
            
            <form class="contact-form" id="project-contact-form" method="post" action="/api/leads/project">
              <input type="hidden" name="_csrf" value="<%= csrfToken %>">
              <% if (process.env.RECAPTCHA_SITE_KEY) { %>
              <input type="hidden" name="recaptchaToken" id="recaptchaTokenProject" data-site-key="<%= process.env.RECAPTCHA_SITE_KEY %>" />
              <% } %>
              <div class="form-group">
                <label for="contact-name"><%= t('forms.fullName','Full name') %></label>
                <input type="text" id="contact-name" name="name" required class="form-input">
              </div>
              
              <div class="form-group">
                <label for="contact-email"><%= t('forms.email','Email Address') %></label>
                <input type="email" id="contact-email" name="email" required class="form-input">
              </div>
              
              <div class="form-group" style="display:grid; grid-template-columns: 140px 1fr; gap: 8px; align-items:end;">
                <div>
                  <label for="contact-cc"><%= t('forms.countryCode','Country code') %></label>
                  <input type="text" id="contact-cc" name="countryCode" class="form-input" placeholder="+49" required>
                </div>
                <div>
                  <label for="contact-phone"><%= t('forms.phoneNumber','Phone Number') %></label>
                  <input type="tel" id="contact-phone" name="phone" class="form-input" placeholder="<%= t('forms.phoneNumber','Phone Number') %>" required>
                </div>
              </div>

              <div class="form-group">
                <label for="contact-language"><%= t('forms.preferredLanguage','Preferred language') %></label>
                <select id="contact-language" name="language" class="form-input">
                  <option value=""><%= t('forms.preferredLanguage','Preferred language') %></option>
                  <% (supportedLanguages || ['en','es','de']).forEach(function(code){ %>
                    <option value="<%= code %>" <%= (lang===code ? 'selected' : '') %>><%= (languageLabels && languageLabels[code]) || code.toUpperCase() %></option>
                  <% }) %>
                </select>
              </div>
              
              <div class="form-group">
                <label for="contact-message"><%= t('forms.message','Message') %></label>
                <textarea id="contact-message" name="message" rows="4" required class="form-textarea" 
                          placeholder="<%= t('projects.detail.messagePlaceholder','Tell us about your interest in this project...') %>"></textarea>
              </div>
              
              <input type="hidden" name="projectId" value="<%= project.id %>" />
              <button type="submit" class="btn btn-primary btn-block">
                <i class="fas fa-paper-plane"></i>
                <%= t('common.sendMessage','Send Message') %>
              </button>
            </form>
          </div>

          <!-- Project Quick Info -->
          <div class="quick-info-card">
            <h3>Project Details</h3>
            
            <div class="info-list">
              <% if (project.type) { %>
                <div class="info-item">
                  <span class="info-label">Type:</span>
                  <span class="info-value"><%= project.type %></span>
                </div>
              <% } %>
              
              <% if (project.total_units) { %>
                <div class="info-item">
                  <span class="info-label">Total Units:</span>
                  <span class="info-value"><%= project.total_units %></span>
                </div>
              <% } %>
              
              <% if (project.completion_date) { %>
                <div class="info-item">
                  <span class="info-label">Completion:</span>
                  <span class="info-value"><%= project.completion_date %></span>
                </div>
              <% } %>
              
              <% if (project.price_range) { %>
                <div class="info-item">
                  <span class="info-label">Price Range:</span>
                  <span class="info-value"><%= project.price_range %></span>
                </div>
              <% } %>
              
              <div class="info-item">
                <span class="info-label">Status:</span>
                <span class="info-value status-<%= project.status %>"><%= project.status %></span>
              </div>
            </div>
          </div>

          <!-- Related Projects -->
          <% if (relatedProjects && relatedProjects.length > 0) { %>
            <div class="related-projects-card">
              <h3><%= t('projects.detail.related','Related Projects') %></h3>
              
              <div class="related-projects-list">
                <% relatedProjects.forEach(relatedProject => { %>
                  <div class="related-project-item">
                    <div class="related-project-image">
                      <% if (relatedProject.photos && relatedProject.photos.length > 0) { %>
                        <img src="<%= relatedProject.photos[0] %>" 
                             alt="<%= relatedProject.title %>">
                      <% } else { %>
                        <div class="placeholder-image">
                          <i class="fas fa-image"></i>
                        </div>
                      <% } %>
                    </div>
                    
                    <div class="related-project-content">
                      <h4><%= relatedProject.title %></h4>
                      <p class="location"><%= relatedProject.city %>, <%= relatedProject.country %></p>
                      <a href="/projects/<%= relatedProject.slug %>" class="btn btn-outline btn-sm"><%= t('projects.viewDetails','View project details') %></a>
                    </div>
                  </div>
                <% }) %>
              </div>
            </div>
          <% } %>
        </div>
      </div>
    </div>
  </section>

  
</div>

<!-- Mobile mount for contact form -->
<div class="mobile-project-contact" aria-hidden="true" style="display:none"></div>

<script src="/js/project-recaptcha.js"></script>
<!-- PDF Download Loading Modal -->
<div id="pdfLoadingModal" class="pdf-loading-modal" style="display: none;">
  <div class="pdf-loading-content">
    <div class="pdf-loading-spinner"></div>
    <p>Generating PDF expose...</p>
    <p class="pdf-loading-subtitle">Please wait, this may take a few moments</p>
  </div>
</div>

<script src="/js/project-detail.js" defer></script>
<script src="/js/pdf-download.js"></script>