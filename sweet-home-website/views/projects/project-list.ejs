<% title = 'Development Projects' %>
<link rel="stylesheet" href="/css/project-list.css" />

<!-- Locations data for JavaScript -->
<div id="locations-data" data-locations='<%- JSON.stringify(locations).replace(/'/g, '&#39;') %>' style="display: none;"></div>

<div class="project-search-page">
  <!-- Search Header removed per design request; dark header enabled in layout -->

  <div class="container-wide">
    <div class="project-layout">
      <!-- Filters Sidebar -->
      <aside class="filters-sidebar" id="filtersSidebar" aria-hidden="true">
        <div class="filters-header">
          <h3><%= t('projects.list.filters.title','Filters') %></h3>
          <div style="display:flex; gap:8px; align-items:center;">
            <button type="button" class="clear-filters" onclick="clearAllFilters()"><%= t('common.clearAll','Clear All') %></button>
            <button type="button" class="filters-close" aria-label="<%= t('common.close','Close') %>">×</button>
          </div>
        </div>
        
        <form id="filtersForm" class="filters-form">
          <!-- Location Filters -->
          <div class="filter-group">
            <h4><%= t('properties.list.location','Location') %></h4>
            <div class="form-group">
              <label for="filterCountry"><%= t('forms.country','Country') %></label>
              <select id="filterCountry" name="country" class="form-select" onchange="updateCities()">
                <option value=""><%= t('forms.anyCountry','Any country') %></option>
                <% Object.keys(locations).forEach(country => { %>
                  <option value="<%= country %>" <%= locals.filters?.country === country ? 'selected' : '' %>><%= country %></option>
                <% }); %>
              </select>
            </div>
            
            <div class="form-group">
              <label for="filterCity"><%= t('forms.city','City') %></label>
              <select id="filterCity" name="city" class="form-select" onchange="updateNeighborhoods()">
                <option value=""><%= t('forms.anyCity','Any City') %></option>
                <!-- Cities will be populated dynamically -->
              </select>
            </div>
            
            <div class="form-group">
              <label for="filterNeighborhood"><%= t('forms.neighborhood','Neighborhood') %></label>
              <select id="filterNeighborhood" name="neighborhood" class="form-select">
                <option value=""><%= t('forms.anyNeighborhood','Any Neighborhood') %></option>
                <!-- Neighborhoods will be populated dynamically -->
              </select>
            </div>
          </div>

          <!-- Type of Units -->
          <div class="filter-group">
            <h4><%= t('projects.list.typeOfUnits','Type of Units') %></h4>
            <div class="checkbox-group">
              <label class="checkbox-label">
                <input type="checkbox" name="unit_type" value="Villas" <%= locals.filters?.unit_type?.includes('Villas') ? 'checked' : '' %>>
                <span class="checkmark"></span>
                <%= t('projects.list.units.villas','Villas') %>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" name="unit_type" value="Apartments" <%= locals.filters?.unit_type?.includes('Apartments') ? 'checked' : '' %>>
                <span class="checkmark"></span>
                <%= t('projects.list.units.apartments','Apartments') %>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" name="unit_type" value="Houses" <%= locals.filters?.unit_type?.includes('Houses') ? 'checked' : '' %>>
                <span class="checkmark"></span>
                <%= t('projects.list.units.houses','Houses') %>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" name="unit_type" value="Offices" <%= locals.filters?.unit_type?.includes('Offices') ? 'checked' : '' %>>
                <span class="checkmark"></span>
                <%= t('projects.list.units.offices','Offices') %>
              </label>
            </div>
          </div>

          <!-- Price per Unit -->
          <div class="filter-group">
            <h4><%= t('projects.list.pricePerUnit.title','Price per Unit') %></h4>
            <div class="form-group">
              <label for="minUnitPrice"><%= t('projects.list.pricePerUnit.min','Min Price') %></label>
              <input id="minUnitPriceDisplay" type="text" inputmode="decimal" placeholder="€0.00" class="form-input" value="<%= (locals.filters?.min_price ? new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(Number(locals.filters.min_price)) : '') %>">
              <input id="minUnitPrice" name="min_price" type="hidden" value="<%= locals.filters?.min_price || '' %>">
            </div>
            <div class="form-group">
              <label for="maxUnitPrice"><%= t('projects.list.pricePerUnit.max','Max Price') %></label>
              <input id="maxUnitPriceDisplay" type="text" inputmode="decimal" placeholder="€0.00" class="form-input" value="<%= (locals.filters?.max_price ? new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(Number(locals.filters.max_price)) : '') %>">
              <input id="maxUnitPrice" name="max_price" type="hidden" value="<%= locals.filters?.max_price || '' %>">
            </div>
          </div>

          <!-- Apply Filters Button -->
          <button type="submit" class="btn btn-primary btn-block"><%= t('projects.list.apply','Apply Filters') %></button>
          <button type="button" class="btn btn-light clear-filters" style="margin-top:8px;"><%= t('common.clearAll','Clear All') %></button>
        </form>
      </aside>

      <!-- Main Content -->
      <main class="project-main">
        <!-- Results Header -->
        <div class="results-header">
          <div class="results-info">
            <h2><%= totalProjects %> <%= t('projects.list.found','Projects Found') %></h2>
            <p>
              <% if (locals.query || Object.values(locals.filters).some(v => v && (Array.isArray(v) ? v.length > 0 : true))) { %>
                <%= t('projects.list.showing','Showing') %> <%= projects.length %> <%= t('projects.list.of','of') %> <%= totalProjects %> <%= t('projects.list.results','results') %>
                <% if (locals.query) { %>
                  <%= t('projects.list.for','for') %> "<%= locals.query %>"
                <% } %>
                <% if (locals.filters.country || locals.filters.city) { %>
                  <%= t('projects.list.in','in') %> <%= locals.filters.city || locals.filters.country %>
                <% } %>
              <% } else { %>
                <%= t('projects.list.browseAll','Browse all available development projects') %>
              <% } %>
            </p>
            
            <!-- Active Filters Display -->
            <% if (Object.values(locals.filters).some(v => v && (Array.isArray(v) ? v.length > 0 : true))) { %>
              <div class="active-filters">
                <span class="active-filters-label"><%= t('projects.list.activeFilters','Active filters:') %></span>
                <% if (locals.filters.country) { %>
                  <span class="filter-tag">
                    <%= locals.filters.country %>
                    <button onclick="removeFilter('country')" class="filter-remove">&times;</button>
                  </span>
                <% } %>
                <% if (locals.filters.city) { %>
                  <span class="filter-tag">
                    <%= locals.filters.city %>
                    <button onclick="removeFilter('city')" class="filter-remove">&times;</button>
                  </span>
                <% } %>
                <% if (locals.filters.type && locals.filters.type.length > 0) { %>
                  <% locals.filters.type.forEach(type => { %>
                    <span class="filter-tag">
                      <%= type %>
                      <button onclick="removeFilter('type', '<%= type %>')" class="filter-remove">&times;</button>
                    </span>
                  <% }) %>
                <% } %>
              </div>
            <% } %>
          </div>
          
          <div class="results-controls">
            <div class="sort-controls">
              <label for="sortBy"><%= t('common.sortBy','Sort by:') %></label>
              <select id="sortBy" name="sort" class="form-select" onchange="updateSort()">
                <option value="date_new" <%= locals.sort === 'date_new' ? 'selected' : '' %>><%= t('common.sort.newest','Newest First') %></option>
                <option value="date_old" <%= locals.sort === 'date_old' ? 'selected' : '' %>><%= t('common.sort.oldest','Oldest First') %></option>
                <option value="name_asc" <%= locals.sort === 'name_asc' ? 'selected' : '' %>><%= t('projects.list.sort.nameAsc','Name: A-Z') %></option>
                <option value="name_desc" <%= locals.sort === 'name_desc' ? 'selected' : '' %>><%= t('projects.list.sort.nameDesc','Name: Z-A') %></option>
                <option value="completion_date" <%= locals.sort === 'completion_date' ? 'selected' : '' %>><%= t('projects.list.sort.completion','Completion Date') %></option>
              </select>
            </div>
            <button class="mobile-filters-trigger"><%= t('projects.list.filters.title','Filters') %></button>
          </div>
        </div>

        <!-- Projects Grid -->
        <div class="projects-container">
          <% if (projects.length > 0) { %>
            <div class="projects-grid" id="projectsGrid">
              <% projects.forEach(project => { %>
                <div class="project-card" data-project-id="<%= project.id %>" data-project-slug="<%= project.slug %>" data-unit-types='<%- JSON.stringify(project.unit_types||[]) %>'>
                  
                  <!-- Project Image -->
                  <div class="project-image">
                    <% if (project.photos && project.photos.length > 0) { %>
                      <% const first = project.photos[0];
                         const dot = first.lastIndexOf('.');
                         const base = dot > -1 ? first.slice(0, dot) : first; %>
                      <% if (project.has_variants && project.variant_base) { %>
                        <picture>
                          <source srcset="<%= project.variant_base %>-320.avif 320w, <%= project.variant_base %>-640.avif 640w, <%= project.variant_base %>-960.avif 960w, <%= project.variant_base %>-1280.avif 1280w, <%= project.variant_base %>-1920.avif 1920w" type="image/avif">
                          <source srcset="<%= project.variant_base %>-320.webp 320w, <%= project.variant_base %>-640.webp 640w, <%= project.variant_base %>-960.webp 960w, <%= project.variant_base %>-1280.webp 1280w, <%= project.variant_base %>-1920.webp 1920w" type="image/webp">
                          <img src="<%= first %>" alt="<%= project.title %>"
                               srcset="<%= project.variant_base %>-320.jpg 320w, <%= project.variant_base %>-640.jpg 640w, <%= project.variant_base %>-960.jpg 960w, <%= project.variant_base %>-1280.jpg 1280w, <%= project.variant_base %>-1920.jpg 1920w"
                               sizes="(max-width: 640px) 100vw, (max-width: 1024px) 50vw, 350px"
                               loading="lazy" decoding="async"
                               onerror="this.src='/img/project-placeholder.jpg'">
                        </picture>
                      <% } else { %>
                        <img src="<%= first %>" alt="<%= project.title %>" loading="lazy" decoding="async" onerror="this.src='/img/project-placeholder.jpg'">
                      <% } %>
                    <% } else { %>
                      <img src="/img/project-placeholder.jpg" alt="<%= project.title %>">
                    <% } %>
                    
                    <!-- Project Badges (top-left) -->
                    <div class="project-badges">
                      <% if (project.completion_date) { %>
                        <span class="badge badge-completion"><%= t('projects.list.completion','Completion') %>: <%= new Date(project.completion_date).getFullYear() %></span>
                      <% } %>
                    </div>
                    <!-- Project Actions (top-right) -->
                    <div class="project-actions">
                      <% if (project.unit_types && project.unit_types.length) { %>
                        <button class="badge badge-type" type="button" data-open-units="<%= project.id %>">
                          <%= project.unit_types.length <= 2 ? project.unit_types.join(', ') : (project.unit_types[0] + ' +') %>
                        </button>
                      <% } %>
                    </div>
                  </div>
                  
                  <!-- Project Content -->
                  <div class="project-content">
                    <h3 class="project-title"><%= project.title %></h3>
                    
                    <div class="project-location">
                      <span class="icon icon-16 icon-inline icon-mask icon-location" style="color: #000;"></span>
                      <%= project.city %>, <%= project.country %>
                    </div>
                    
                    <div class="project-details">
                      <% if (project.total_units) { %>
                        <div class="detail-item">
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                            <polyline points="9,22 9,12 15,12 15,22"></polyline>
                          </svg>
                          <%= project.total_units %> units
                        </div>
                      <% } %>
                      <% if (project.completion_date) { %>
                        <div class="detail-item">
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <polyline points="15,4 20,9 20,20 4,20 4,4 15,4"></polyline>
                          </svg>
                          <%= new Date(project.completion_date).toLocaleDateString() %>
                        </div>
                      <% } %>
                      <% if (project.min_price || project.max_price) { %>
                        <div class="price-range">
                          <% const eur = new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }); %>
                          <% if (project.min_price && project.max_price) { %>
                            From: <%= eur.format(Number(project.min_price)) %> to <%= eur.format(Number(project.max_price)) %>
                          <% } else if (project.min_price) { %>
                            From: <%= eur.format(Number(project.min_price)) %>
                          <% } else { %>
                            Up to: <%= eur.format(Number(project.max_price)) %>
                          <% } %>
                        </div>
                      <% } %>
                    </div>
                    
                    <% if (project.description) { %>
                      <div class="project-description">
                        <%= project.description.length > 120 ? project.description.substring(0, 120) + '...' : project.description %>
                      </div>
                    <% } %>
                    
                    <div class="project-footer">
                      <button class="btn btn-outline btn-sm" onclick="event.stopPropagation(); window.location.href='/projects/<%= project.slug %>'">
                        <%= t('projects.viewDetails','View project details') %>
                      </button>
                    </div>
                  </div>
                </div>
              <% }); %>
            </div>
            
            <!-- Pagination -->
            <% if (totalPages > 1) { %>
              <div class="pagination">
                <% if (currentPage > 1) { %>
                  <a href="?<%= new URLSearchParams({...queryParams, page: currentPage - 1}) %>" class="page-link"><%= t('common.previous','Previous') %></a>
                <% } %>
                
                <% for (let i = 1; i <= totalPages; i++) { %>
                  <% if (i === currentPage) { %>
                    <span class="page-link active"><%= i %></span>
                  <% } else if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) { %>
                    <a href="?<%= new URLSearchParams({...queryParams, page: i}) %>" class="page-link"><%= i %></a>
                  <% } else if (i === currentPage - 3 || i === currentPage + 3) { %>
                    <span class="page-link">...</span>
                  <% } %>
                <% } %>
                
                <% if (currentPage < totalPages) { %>
                  <a href="?<%= new URLSearchParams({...queryParams, page: currentPage + 1}) %>" class="page-link"><%= t('common.next','Next') %></a>
                <% } %>
              </div>
            <% } %>
            
          <% } else { %>
            <div class="no-results">
              <div class="no-results-icon">🏗️</div>
              <h3><%= t('projects.list.noResults.title','No Projects Found') %></h3>
              <p><%= t('projects.list.noResults.hint','Try adjusting your search criteria or browse all available projects.') %></p>
              <div class="no-results-actions">
                <button type="button" class="btn btn-secondary" onclick="clearAllFilters()"><%= t('projects.list.clearFilters','Clear Filters') %></button>
                <a href="/projects" class="btn btn-primary"><%= t('projects.list.browseAll','Browse all available development projects') %></a>
              </div>
            </div>
          <% } %>
        </div>
      </main>
    </div>
  </div>
  <div id="filtersOverlay" class="filters-overlay"></div>
</div>

<script src="/js/project-list.js"></script>
