<% title = 'Projects' %>
<link rel="stylesheet" href="/css/admin/all-projects.css" />

<div id="ap-data" data-locations='<%- JSON.stringify(locations || {}).replace(/'/g, '&#39;') %>'></div>

<div class="page-wrap">
  <!-- Header -->
  <div class="section-header">
    <h1>All Projects</h1>
    <div class="header-actions">
      <a href="/admin/dashboard" class="link-home">← Return to dashboard</a>
      <a href="/superadmin/dashboard/projects/new" class="btn btn-primary">New Project</a>
    </div>
  </div>

  <!-- Filters -->
  <form class="filters" id="filterForm" method="get">
    <select id="countrySelect" name="country">
      <option value="">All Countries</option>
      <% (countryOptions || []).forEach(c => { %>
        <option value="<%= c %>" <%= (filters && filters.country === c) ? 'selected' : '' %>><%= c %></option>
      <% }) %>
    </select>

    <select id="citySelect" name="city" <%= !(filters && filters.country) ? 'disabled' : '' %>>
      <option value="">All Cities</option>
      <% (cityOptions || []).forEach(ct => { %>
        <option value="<%= ct %>" <%= (filters && filters.city === ct) ? 'selected' : '' %>><%= ct %></option>
      <% }) %>
    </select>

    <a class="link-reset" href="?">Reset</a>
  </form>

  <!-- Projects Grid with internal pagination (2 rows per page) -->
  <% if (!projects || projects.length === 0) { %>
    <div class="empty-state">
      <p>No projects found.</p>
    </div>
  <% } else { %>
    <div class="cards-grid" id="adminProjectsGrid">
      <% projects.forEach(function(p) { %>
        <article class="project-card">
          <% const cover = (Array.isArray(p.photos) && p.photos[0]) ? p.photos[0] : null; %>
          <% if (cover) { %>
            <img class="thumb" src="<%= cover %>" alt="<%= p.title %>">
          <% } else { %>
            <div class="thumb thumb--placeholder" aria-label="No image available"></div>
          <% } %>
          <div class="card-body">
            <h3 class="title"><%= p.title %></h3>
            <p class="meta">
              <%= p.country %><% if (p.city) { %> — <%= p.city %><% } %><% if (p.neighborhood) { %>, <%= p.neighborhood %><% } %>
            </p>
            <div class="actions">
              <form action="/superadmin/dashboard/projects/<%= p.id %>/delete" method="post" onsubmit="return confirm('Delete “<%= p.title %>”?');">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <button type="submit" class="btn btn-danger">Delete</button>
              </form>
              <a class="btn btn-secondary" href="/admin/dashboard/projects/<%= p.id %>/edit">Edit</a>
              <a class="btn btn-ghost" href="/projects/<%= p.slug || p.id %>">View</a>
            </div>
          </div>
        </article>
      <% }) %>
    </div>
    <nav class="pagination" id="adminInternalPagination" style="display:flex;align-items:center;gap:.5rem;justify-content:center;margin-top:12px;">
      <button type="button" class="page-btn prev" disabled>« Prev</button>
      <span class="page-info">Page 1</span>
      <button type="button" class="page-btn next">Next »</button>
    </nav>
  <% } %>
</div>

<script>
  (function () {
    const dataNode = document.getElementById('ap-data');
    let LOCATIONS = {};
    try { LOCATIONS = JSON.parse(dataNode.getAttribute('data-locations') || '{}'); } catch(_) { LOCATIONS = {}; }
    const countrySel = document.getElementById('countrySelect');
    const citySel    = document.getElementById('citySelect');
    const form       = document.getElementById('filterForm');

    if (!countrySel || !citySel) return;

    countrySel.addEventListener('change', () => {
      const country = countrySel.value;
      const cityObj = (LOCATIONS && LOCATIONS[country]) || {};
      const cities  = Object.keys(cityObj);

      citySel.innerHTML = '<option value="">All Cities</option>';
      if (cities.length) {
        cities.forEach(ct => {
          const opt = document.createElement('option');
          opt.value = ct;
          opt.textContent = ct;
          citySel.appendChild(opt);
        });
        citySel.disabled = false;
      } else {
        citySel.disabled = true;
      }

      form.submit(); // auto-apply filter
    });

    citySel.addEventListener('change', () => form.submit());
  })();
</script>
<script>
  (function() {
    const grid = document.getElementById('adminProjectsGrid');
    const nav  = document.getElementById('adminInternalPagination');
    if (!grid || !nav) return;

    const cards = Array.from(grid.children);
    const prevBtn = nav.querySelector('.prev');
    const nextBtn = nav.querySelector('.next');
    const infoEl  = nav.querySelector('.page-info');
    let currentPage = 1;
    let totalPages = 1;
    let pageSize = 1;

    function computeColumns() {
      if (cards.length === 0) return 1;
      const firstTop = cards[0].offsetTop;
      let cols = 0;
      for (let i = 0; i < cards.length; i++) {
        if (cards[i].offsetTop !== firstTop) break;
        cols++;
      }
      return Math.max(1, cols);
    }

    function recalc() {
      const cols = computeColumns();
      pageSize = Math.max(1, cols * 2); // 2 rows per page
      totalPages = Math.max(1, Math.ceil(cards.length / pageSize));
      if (currentPage > totalPages) currentPage = totalPages;
      render();
    }

    function render() {
      const start = (currentPage - 1) * pageSize;
      const end   = start + pageSize;
      cards.forEach((card, idx) => {
        card.style.display = (idx >= start && idx < end) ? '' : 'none';
      });
      prevBtn.disabled = currentPage <= 1;
      nextBtn.disabled = currentPage >= totalPages;
      if (infoEl) infoEl.textContent = 'Page ' + currentPage + ' of ' + totalPages;
    }

    prevBtn.addEventListener('click', function() { if (currentPage > 1) { currentPage--; render(); } });
    nextBtn.addEventListener('click', function() { if (currentPage < totalPages) { currentPage++; render(); } });

    window.addEventListener('load', recalc);
    let t;
    window.addEventListener('resize', function() { clearTimeout(t); t = setTimeout(recalc, 150); });
    recalc();
  })();
</script>