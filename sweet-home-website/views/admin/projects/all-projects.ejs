<% title = 'Projects' %>
<link rel="stylesheet" href="/css/admin/all-projects.css" />

<div id="ap-data" data-locations='<%- JSON.stringify(locations || {}).replace(/'/g, '&#39;') %>'></div>

<div class="page-wrap">
  <!-- Header -->
  <div class="section-header">
    <h1>All Projects</h1>
    <div class="header-actions">
      <a href="/admin/dashboard" class="link-home">← Return to dashboard</a>
      <a href="/superadmin/dashboard/projects/new" class="btn btn-primary">New Project</a>
    </div>
  </div>

  <!-- Filters -->
  <form class="filters" id="filterForm" method="get">
    <select id="countrySelect" name="country">
      <option value="">All Countries</option>
      <% (countryOptions || []).forEach(c => { %>
        <option value="<%= c %>" <%= (filters && filters.country === c) ? 'selected' : '' %>><%= c %></option>
      <% }) %>
    </select>

    <select id="citySelect" name="city" <%= !(filters && filters.country) ? 'disabled' : '' %>>
      <option value="">All Cities</option>
      <% (cityOptions || []).forEach(ct => { %>
        <option value="<%= ct %>" <%= (filters && filters.city === ct) ? 'selected' : '' %>><%= ct %></option>
      <% }) %>
    </select>

    <a class="link-reset" href="?">Reset</a>
  </form>

  <!-- Projects Grid with Collapsible Sections -->
  <% if (!projects || projects.length === 0) { %>
    <div class="empty-state">
      <p>No projects found.</p>
    </div>
  <% } else { %>
    <% 
      // Group projects by country
      const grouped = {};
      projects.forEach(p => {
        if (!grouped[p.country]) grouped[p.country] = [];
        grouped[p.country].push(p);
      });
    %>
    
    <% Object.keys(grouped).forEach(country => { %>
      <% const list = grouped[country]; %>
      <div class="country-section" data-country="<%= country %>">
        <div class="country-header">
          <h3><%= country %> (<%= list.length %>)</h3>
          <% if (list.length > 8) { %>
            <button type="button" class="toggle-section-btn" data-expanded="false">
              <span class="toggle-text">Show All</span>
              <span class="toggle-icon">▼</span>
            </button>
          <% } %>
        </div>
        <div class="cards-grid">
          <% list.forEach(function(p, idx) { %>
            <article class="project-card" style="<%= idx >= 8 ? 'display: none;' : '' %>" data-index="<%= idx %>">
              <% const cover = (Array.isArray(p.photos) && p.photos[0]) ? p.photos[0] : null; %>
              <% if (cover) { %>
                <img class="thumb" src="<%= cover %>" alt="<%= p.title %>">
              <% } else { %>
                <div class="thumb thumb--placeholder" aria-label="No image available"></div>
              <% } %>
              <div class="card-body">
                <h3 class="title"><%= p.title %></h3>
                <p class="meta">
                  <%= p.country %><% if (p.city) { %> — <%= p.city %><% } %><% if (p.neighborhood) { %>, <%= p.neighborhood %><% } %>
                </p>
                <div class="actions">
                  <form action="/superadmin/dashboard/projects/<%= p.id %>/delete" method="post" onsubmit="return confirm('Delete "<%= p.title %>"?');">
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                    <button type="submit" class="btn btn-danger">Delete</button>
                  </form>
                  <a class="btn btn-secondary" href="/admin/dashboard/projects/<%= p.id %>/edit">Edit</a>
                  <a class="btn btn-ghost" href="/projects/<%= p.slug || p.id %>">View</a>
                </div>
              </div>
            </article>
          <% }) %>
        </div>
      </div>
    <% }); %>
  <% } %>

  <!-- Pagination -->
  <nav class="pagination">
    <% 
      const qs = (page) => {
        const params = new URLSearchParams();
        params.set('page', page);
        if (filters && filters.country) params.set('country', filters.country);
        if (filters && filters.city)    params.set('city', filters.city);
        return '?' + params.toString();
      };
    %>
    <% if (currentPage > 1) { %>
      <a class="page-link" href="<%= qs(currentPage - 1) %>">« Prev</a>
    <% } %>
    <span class="page-info">Page <%= currentPage %> of <%= totalPages %></span>
    <% if (currentPage < totalPages) { %>
      <a class="page-link" href="<%= qs(currentPage + 1) %>">Next »</a>
    <% } %>
  </nav>
</div>

<script>
  (function () {
    const dataNode = document.getElementById('ap-data');
    let LOCATIONS = {};
    try { LOCATIONS = JSON.parse(dataNode.getAttribute('data-locations') || '{}'); } catch(_) { LOCATIONS = {}; }
    const countrySel = document.getElementById('countrySelect');
    const citySel    = document.getElementById('citySelect');
    const form       = document.getElementById('filterForm');

    if (!countrySel || !citySel) return;

    countrySel.addEventListener('change', () => {
      const country = countrySel.value;
      const cityObj = (LOCATIONS && LOCATIONS[country]) || {};
      const cities  = Object.keys(cityObj);

      citySel.innerHTML = '<option value="">All Cities</option>';
      if (cities.length) {
        cities.forEach(ct => {
          const opt = document.createElement('option');
          opt.value = ct;
          opt.textContent = ct;
          citySel.appendChild(opt);
        });
        citySel.disabled = false;
      } else {
        citySel.disabled = true;
      }

      form.submit(); // auto-apply filter
    });

    citySel.addEventListener('change', () => form.submit());
  })();

  // Collapsible sections
  document.querySelectorAll('.toggle-section-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const section = this.closest('.country-section');
      const cards = section.querySelectorAll('.project-card');
      const isExpanded = this.getAttribute('data-expanded') === 'true';
      
      cards.forEach((card, idx) => {
        if (idx >= 8) {
          card.style.display = isExpanded ? 'none' : '';
        }
      });
      
      this.setAttribute('data-expanded', !isExpanded);
      this.querySelector('.toggle-text').textContent = isExpanded ? 'Show All' : 'Show Less';
      this.querySelector('.toggle-icon').textContent = isExpanded ? '▼' : '▲';
    });
  });
</script>