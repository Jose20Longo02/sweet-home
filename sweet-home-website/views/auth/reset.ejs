<% title = 'Reset Password' %>
<link rel="stylesheet" href="/css/auth/login.css">

<div class="login-wrap">
  <form action="/auth/reset" method="post" class="auth-form">
    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
    <h1>Create a new password</h1>

    <% if (error) { %>
      <div class="alert alert-error"><%= error %></div>
    <% } %>

    <label for="token">Reset code</label>
    <input id="token" name="token" type="text" value="<%= typeof token !== 'undefined' ? token : '' %>" placeholder="Paste the code from your email" required />

    <label for="password">New password</label>
    <input id="password" name="password" type="password" autocomplete="new-password" required />

    <label for="passwordConfirm">Confirm new password</label>
    <input id="passwordConfirm" name="passwordConfirm" type="password" autocomplete="new-password" required />

    <div id="pwdMismatch" class="alert alert-error" style="display:none; margin-top:8px;">Passwords do not match.</div>

    <button type="submit">Reset password</button>

    <p>
      <a href="/auth/login">Back to sign in</a>
    </p>
  </form>
  <p class="auth-helper-text">Choose any password you prefer. Make sure you remember it.</p>
</div>

<!-- Resetting Overlay -->
<div id="resetOverlay" class="upload-overlay" hidden style="display:none;">
  <div class="upload-dialog">
    <div class="upload-spinner"></div>
    <div>
      <div class="upload-title">Resetting...</div>
      <div class="upload-sub">Please wait while we update your password.</div>
    </div>
  </div>
  <style>
    .upload-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.45); display: flex; align-items: center; justify-content: center; z-index: 3000; }
    .upload-dialog { background: #ffffff; border-radius: 12px; padding: 18px 22px; box-shadow: 0 10px 30px rgba(0,0,0,.25); display: flex; align-items: center; gap: 12px; min-width: 280px; }
    .upload-spinner { width: 22px; height: 22px; border: 3px solid #e5e7eb; border-top-color: var(--primary-color); border-radius: 50%; animation: upload-spin 1s linear infinite; }
    .upload-title { font-family: 'Lato', system-ui, -apple-system, Segoe UI, Roboto, sans-serif; font-weight: 600; color: #111; }
    .upload-sub { font-size: 12px; color: #666; margin-top: 2px; }
    @keyframes upload-spin { to { transform: rotate(360deg); } }
  </style>
</div>

<script src="/js/auth-reset.js" defer></script>
<script>
  (function () {
    const form = document.querySelector('.auth-form');
    const p1 = document.getElementById('password');
    const p2 = document.getElementById('passwordConfirm');
    const alertBox = document.getElementById('pwdMismatch');

    function checkMatch() {
      const mismatch = p1.value !== p2.value;
      alertBox.style.display = mismatch ? 'block' : 'none';
      return !mismatch;
    }

    p1.addEventListener('input', checkMatch);
    p2.addEventListener('input', checkMatch);
    form.addEventListener('submit', (e) => {
      if (!checkMatch()) {
        e.preventDefault();
      }
    });
  })();
</script>


