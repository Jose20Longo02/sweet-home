<!DOCTYPE html>
<html lang="<%= typeof lang !== 'undefined' ? lang : 'en' %>">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title><%= title %> | Sweet Home</title>
  <link rel="icon" type="image/png" href="/images/favicon.png" sizes="32x32">
  <link rel="icon" type="image/png" href="/images/favicon.png" sizes="16x16">
  <link rel="apple-touch-icon" href="/images/favicon.png">
  <!-- Fonts: Playfair Display for headings, Lato for body -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Playfair+Display:wght@600;700&family=Great+Vibes&display=swap">
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Playfair+Display:wght@600;700&family=Great+Vibes&display=swap" rel="stylesheet">
  <% if (typeof headPartial !== 'undefined' && headPartial) { try { %>
    <%- include(headPartial) %>
  <% } catch (e) { /* safely ignore optional head partial errors */ } } %>
  <link rel="preload" as="style" href="/css/styles.css" />
  <link rel="stylesheet" href="/css/styles.css" />
  <link rel="preload" as="style" href="/css/variables.css" />
  <link rel="stylesheet" href="/css/variables.css" />
  <meta name="csrf-token" content="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">
  <!-- Dynamic Icon Theme CSS Variables - Must come after styles.css to override -->
  <link rel="stylesheet" href="/css/icon-theme.css" />
  <% if ((typeof GA_MEASUREMENT_ID !== 'undefined' && GA_MEASUREMENT_ID) && !(typeof currentPath !== 'undefined' && (/^\/(admin|superadmin)/).test(currentPath))) { %>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=<%= GA_MEASUREMENT_ID %>"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      // Consent Mode: analytics_storage defaults to 'granted' for proper user tracking
      // Set GA_CONSENT_DEFAULT=denied in .env if you need to implement a consent banner
      const consentDefault = '<%= GA_CONSENT_DEFAULT %>' || 'granted';
      gtag('consent', 'default', { 
        'ad_storage': 'denied',  // Always deny ad storage by default
        'analytics_storage': consentDefault  // Allow analytics for user tracking
      });
      gtag('config', '<%= GA_MEASUREMENT_ID %>');
    </script>
  <% } %>
  <% if (!(typeof currentPath !== 'undefined' && (/^\/(admin|superadmin)/).test(currentPath))) { %>
    <!-- Meta Pixel Code -->
    <script>
      !function(f,b,e,v,n,t,s)
      {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
      n.callMethod.apply(n,arguments):n.queue.push(arguments)};
      if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
      n.queue=[];t=b.createElement(e);t.async=!0;
      t.src=v;s=b.getElementsByTagName(e)[0];
      s.parentNode.insertBefore(t,s)}(window, document,'script',
      'https://connect.facebook.net/en_US/fbevents.js');
      fbq('init', '1575759736952664');
      fbq('track', 'PageView');
    </script>
    <noscript><img height="1" width="1" style="display:none"
      src="https://www.facebook.com/tr?id=1575759736952664&ev=PageView&noscript=1"
    /></noscript>
    <!-- End Meta Pixel Code -->
  <% } %>
  <% if (typeof canonicalUrl !== 'undefined' && canonicalUrl) { 
    // Normalize the canonical URL to ensure exact consistency with hreflang
    // Use exact same value for canonical and all hreflang tags - no modifications
    let canonicalHref = String(canonicalUrl).trim();
    // Use ISO 639-1 language codes with ISO 3166-1 alpha-2 country codes (as recommended by SEMrush)
    const supportedHreflangs = [
      { lang: 'en', country: 'US' },  // English - United States (ISO 639-1 + ISO 3166-1 alpha-2)
      { lang: 'es', country: 'ES' },  // Spanish - Spain (ISO 639-1 + ISO 3166-1 alpha-2)
      { lang: 'de', country: 'DE' }    // German - Germany (ISO 639-1 + ISO 3166-1 alpha-2)
    ];
    // Get current language from res.locals.lang (set by i18n middleware) or fallback to 'en'
    let currentLang = 'en';
    if (typeof lang !== 'undefined' && lang) {
      currentLang = String(lang).toLowerCase().slice(0, 2);
    }
    // Ensure currentLang is in the supported list
    if (!supportedHreflangs.some(h => h.lang === currentLang)) {
      currentLang = 'en';
    }
    // Find the current language's country code for self-referencing hreflang
    const currentHreflang = supportedHreflangs.find(h => h.lang === currentLang) || supportedHreflangs[0];
    const currentHreflangValue = currentHreflang.lang + '-' + currentHreflang.country;
  %>
    <!-- Canonical URL - must match hreflang URLs exactly -->
    <link rel="canonical" href="<%= canonicalHref %>">
    <!-- Self-referencing hreflang: MUST match canonical URL exactly and use the current page's language code -->
    <link rel="alternate" hreflang="<%= currentHreflangValue %>" href="<%= canonicalHref %>">
    <!-- All other language alternatives - all point to same URL (cookie-based language switching) -->
    <% supportedHreflangs.forEach(function(hreflang) { 
      const hreflangValue = hreflang.lang + '-' + hreflang.country;
      // Include all language alternatives (including current one for clarity, though self-referencing is above)
      // This ensures all hreflang tags are present and consistent
    %>
    <link rel="alternate" hreflang="<%= hreflangValue %>" href="<%= canonicalHref %>">
    <% }); %>
    <!-- x-default must also match canonical URL exactly -->
    <link rel="alternate" hreflang="x-default" href="<%= canonicalHref %>">
  <% } %>
  <% if ((typeof GA_MEASUREMENT_ID !== 'undefined' && GA_MEASUREMENT_ID) && !(typeof currentPath !== 'undefined' && (/^\/(admin|superadmin)/).test(currentPath))) { %>
    <meta name="ga-measurement-id" content="<%= GA_MEASUREMENT_ID %>">
    <script src="/js/analytics.js" defer></script>
  <% } %>
  <script src="/js/main.js" defer></script>
  <script src="/js/lazy-load.js" defer></script>
</head>
<body class="<%= (typeof stickyFooter !== 'undefined' && stickyFooter) ? 'layout-sticky' : '' %>" data-icon-theme="<%= getActiveTheme ? getActiveTheme() : 'default' %>">
  <a href="#main-content" class="skip-link">Skip to main content</a>
  <% const isAdmin = (typeof currentPath !== 'undefined' ? /^\/admin/.test(currentPath) : false); %>
  <% const isSuperAdmin = (typeof currentPath !== 'undefined' ? /^\/superadmin/.test(currentPath) : false); %>
  <% const isHomePage = (typeof currentPath !== 'undefined' ? currentPath === '/' : false); %>
  <%- include(isSuperAdmin ? '../partials/header-admin' : (isHomePage ? '../partials/header' : '../partials/header-main')) %>
  <main id="main-content" class="<%= (typeof useMainContainer !== 'undefined' && useMainContainer === false) ? '' : 'container' %> <%= (isAdmin || isSuperAdmin || !isHomePage) ? 'main-offset' : '' %>" role="main">
    <%- body %>
  </main>
  <% if (!(isAdmin || isSuperAdmin) && !(typeof hideFooter !== 'undefined' && hideFooter === true)) { %>
    <%- include('../partials/footer') %>
  <% } %>
  
  <!-- Christmas Popup -->
  <% if (getActiveTheme && getActiveTheme() === 'christmas') { %>
    <%
      const isLoggedIn = typeof user !== 'undefined' && user !== null;
      const currentTheme = getActiveTheme();
      const logoPath = (currentTheme === 'christmas') 
        ? '/images/Christmas%20assets/Logo%20-%20christmas.png' 
        : '/images/Sweet%20Home%20Logo.png';
    %>
    <div id="christmas-popup" class="christmas-popup" style="display: none;" data-is-logged-in="<%= isLoggedIn ? 'true' : 'false' %>">
      <div class="christmas-popup__overlay"></div>
      <div class="christmas-popup__content">
        <button class="christmas-popup__close" aria-label="Close popup">&times;</button>
        <div class="christmas-popup__logo">
          <img src="<%= logoPath %>" alt="Sweet Home" onerror="this.style.display='none'">
        </div>
        <h2 class="christmas-popup__main-message">We wish you a merry christmas and a happy 2026!</h2>
        <p class="christmas-popup__secondary-message">
          <% if (isLoggedIn) { %>
            We are extremely grateful for your work this year, and very excited to continue succeeding with you the next year!
          <% } else { %>
            This 2026 we will be here, ready to help you in your next real estate investment.
          <% } %>
        </p>
      </div>
    </div>
    <link rel="stylesheet" href="/css/christmas-popup.css?v=2">
    <script src="/js/christmas-popup.js" defer></script>
  <% } %>
</body>
</html>