<!DOCTYPE html>
<html lang="<%= typeof lang !== 'undefined' ? lang : 'en' %>">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title><%= title %> | Sweet Home</title>
  <link rel="icon" type="image/png" href="/images/favicon.png" sizes="32x32">
  <link rel="icon" type="image/png" href="/images/favicon.png" sizes="16x16">
  <link rel="apple-touch-icon" href="/images/favicon.png">
  <!-- Fonts: Playfair Display for headings, Lato for body -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Playfair+Display:wght@600;700&family=Great+Vibes&display=swap">
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Playfair+Display:wght@600;700&family=Great+Vibes&display=swap" rel="stylesheet">
  <% if (typeof headPartial !== 'undefined' && headPartial) { try { %>
    <%- include(headPartial) %>
  <% } catch (e) { /* safely ignore optional head partial errors */ } } %>
  <link rel="preload" as="style" href="/css/styles.css" />
  <link rel="stylesheet" href="/css/styles.css" />
  <link rel="preload" as="style" href="/css/variables.css" />
  <link rel="stylesheet" href="/css/variables.css" />
  <meta name="csrf-token" content="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">
  <!-- Dynamic Icon Theme CSS Variables - Must come after styles.css to override -->
  <style id="icon-theme-styles">
    <%
      // Get icon paths and determine if they're PNG (need background-image) or SVG (use mask)
      var iconPathFunc = getIconPath || function(type) { return '/icons/icon_' + type + '.svg'; };
      var bedPath = iconPathFunc('bed');
      var bathPath = iconPathFunc('bath');
      var sizePath = iconPathFunc('size');
      var locationPath = iconPathFunc('location');
      
      // Check if paths are PNG (holiday themes like christmas) or SVG (default theme)
      var isPng = function(path) { return path && path.toLowerCase().indexOf('.png') !== -1; };
      var bedIsPng = isPng(bedPath);
      var bathIsPng = isPng(bathPath);
      var sizeIsPng = isPng(sizePath);
      var locationIsPng = isPng(locationPath);
    %>
    <%
      var propertyTypePath = iconPathFunc('propertyType');
      var occupancyPath = iconPathFunc('occupancy');
      var rentalPath = iconPathFunc('rental');
      var propertyTypeIsPng = isPng(propertyTypePath);
      var occupancyIsPng = isPng(occupancyPath);
      var rentalIsPng = isPng(rentalPath);
    %>
    :root {
      --icon-bed: url('<%= bedPath %>');
      --icon-bath: url('<%= bathPath %>');
      --icon-size: url('<%= sizePath %>');
      --icon-location: url('<%= locationPath %>');
      <% if (propertyTypePath) { %>--icon-property-type: url('<%= propertyTypePath %>');<% } %>
      <% if (occupancyPath) { %>--icon-occupancy: url('<%= occupancyPath %>');<% } %>
      <% if (rentalPath) { %>--icon-rental: url('<%= rentalPath %>');<% } %>
    }
    /* Override icon paths with theme-specific values */
    .icon-bed { 
      --icon: var(--icon-bed) !important;
      <% if (bedIsPng) { %>
      background-image: var(--icon-bed) !important;
      background-size: contain !important;
      background-repeat: no-repeat !important;
      background-position: center !important;
      -webkit-mask: none !important;
      mask: none !important;
      background-color: transparent !important;
      <% } %>
    }
    .icon-bath { 
      --icon: var(--icon-bath) !important;
      <% if (bathIsPng) { %>
      background-image: var(--icon-bath) !important;
      background-size: contain !important;
      background-repeat: no-repeat !important;
      background-position: center !important;
      -webkit-mask: none !important;
      mask: none !important;
      background-color: transparent !important;
      <% } %>
    }
    .icon-size { 
      --icon: var(--icon-size) !important;
      <% if (sizeIsPng) { %>
      background-image: var(--icon-size) !important;
      background-size: contain !important;
      background-repeat: no-repeat !important;
      background-position: center !important;
      -webkit-mask: none !important;
      mask: none !important;
      background-color: transparent !important;
      <% } %>
    }
    .icon-location { 
      --icon: var(--icon-location) !important;
      <% if (locationIsPng) { %>
      background-image: var(--icon-location) !important;
      background-size: contain !important;
      background-repeat: no-repeat !important;
      background-position: center !important;
      -webkit-mask: none !important;
      mask: none !important;
      background-color: transparent !important;
      <% } %>
    }
    <% if (propertyTypePath) { %>
    .icon-property-type { 
      --icon: var(--icon-property-type) !important;
      <% if (propertyTypeIsPng) { %>
      background-image: var(--icon-property-type) !important;
      background-size: contain !important;
      background-repeat: no-repeat !important;
      background-position: center !important;
      -webkit-mask: none !important;
      mask: none !important;
      background-color: transparent !important;
      <% } %>
    }
    <% } %>
    <% if (occupancyPath) { %>
    .icon-occupancy { 
      --icon: var(--icon-occupancy) !important;
      <% if (occupancyIsPng) { %>
      background-image: var(--icon-occupancy) !important;
      background-size: contain !important;
      background-repeat: no-repeat !important;
      background-position: center !important;
      -webkit-mask: none !important;
      mask: none !important;
      background-color: transparent !important;
      <% } %>
    }
    <% } %>
    <% if (rentalPath) { %>
    .icon-rental { 
      --icon: var(--icon-rental) !important;
      <% if (rentalIsPng) { %>
      background-image: var(--icon-rental) !important;
      background-size: contain !important;
      background-repeat: no-repeat !important;
      background-position: center !important;
      -webkit-mask: none !important;
      mask: none !important;
      background-color: transparent !important;
      <% } %>
    }
    <% } %>
    /* Make Christmas icons 1.5x bigger */
    body[data-icon-theme="christmas"] .icon-bed,
    body[data-icon-theme="christmas"] .icon-bath,
    body[data-icon-theme="christmas"] .icon-size,
    body[data-icon-theme="christmas"] .icon-location,
    body[data-icon-theme="christmas"] .icon-property-type,
    body[data-icon-theme="christmas"] .icon-occupancy,
    body[data-icon-theme="christmas"] .icon-rental {
      transform: scale(1.5);
      transform-origin: center;
    }
  </style>
  <% if ((typeof GA_MEASUREMENT_ID !== 'undefined' && GA_MEASUREMENT_ID) && !(typeof currentPath !== 'undefined' && (/^\/(admin|superadmin)/).test(currentPath))) { %>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=<%= GA_MEASUREMENT_ID %>"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      // Consent Mode: analytics_storage defaults to 'granted' for proper user tracking
      // Set GA_CONSENT_DEFAULT=denied in .env if you need to implement a consent banner
      const consentDefault = '<%= GA_CONSENT_DEFAULT %>' || 'granted';
      gtag('consent', 'default', { 
        'ad_storage': 'denied',  // Always deny ad storage by default
        'analytics_storage': consentDefault  // Allow analytics for user tracking
      });
      gtag('config', '<%= GA_MEASUREMENT_ID %>');
    </script>
  <% } %>
  <% if (!(typeof currentPath !== 'undefined' && (/^\/(admin|superadmin)/).test(currentPath))) { %>
    <!-- Meta Pixel Code -->
    <script>
      !function(f,b,e,v,n,t,s)
      {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
      n.callMethod.apply(n,arguments):n.queue.push(arguments)};
      if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
      n.queue=[];t=b.createElement(e);t.async=!0;
      t.src=v;s=b.getElementsByTagName(e)[0];
      s.parentNode.insertBefore(t,s)}(window, document,'script',
      'https://connect.facebook.net/en_US/fbevents.js');
      fbq('init', '1575759736952664');
      fbq('track', 'PageView');
    </script>
    <noscript><img height="1" width="1" style="display:none"
      src="https://www.facebook.com/tr?id=1575759736952664&ev=PageView&noscript=1"
    /></noscript>
    <!-- End Meta Pixel Code -->
  <% } %>
  <% if (typeof canonicalUrl !== 'undefined' && canonicalUrl) { %>
    <link rel="canonical" href="<%= canonicalUrl %>">
  <% } %>
  <% if (typeof canonicalUrl !== 'undefined' && canonicalUrl) { %>
    <link rel="alternate" hreflang="en" href="<%= canonicalUrl.replace(/:\/\//, '://').replace(/\/es\//,'/').replace(/\/de\//,'/') %>">
    <link rel="alternate" hreflang="es" href="<%= canonicalUrl.replace(/:\/\//, '://').replace(/:\/\//, '://').replace(/\/de\//,'/es/').replace(/\/en\//,'/es/').replace(/\/$/,'/').replace(/\/\/$/,'/') %>">
    <link rel="alternate" hreflang="de" href="<%= canonicalUrl.replace(/:\/\//, '://').replace(/:\/\//, '://').replace(/\/es\//,'/de/').replace(/\/en\//,'/de/').replace(/\/$/,'/').replace(/\/\/$/,'/') %>">
    <link rel="alternate" hreflang="x-default" href="<%= canonicalUrl.replace(/:\/\//, '://').replace(/\/es\//,'/').replace(/\/de\//,'/') %>">
  <% } %>
  <% if ((typeof GA_MEASUREMENT_ID !== 'undefined' && GA_MEASUREMENT_ID) && !(typeof currentPath !== 'undefined' && (/^\/(admin|superadmin)/).test(currentPath))) { %>
    <script>
      window.GA_MEASUREMENT_ID = '<%= GA_MEASUREMENT_ID %>';
    </script>
    <script src="/js/analytics.js" defer></script>
  <% } %>
  <script src="/js/main.js" defer></script>
  <script>
    // Lazy-load non-critical scripts when idle
    window.requestIdleCallback && requestIdleCallback(function(){
      [
        '/js/home.js'
      ].forEach(function(src){
        var s = document.createElement('script');
        s.src = src; s.defer = true; document.body.appendChild(s);
      });
    });
  </script>
</head>
<body class="<%= (typeof stickyFooter !== 'undefined' && stickyFooter) ? 'layout-sticky' : '' %>" data-icon-theme="<%= getActiveTheme ? getActiveTheme() : 'default' %>">
  <a href="#main-content" class="skip-link">Skip to main content</a>
  <% const isAdmin = (typeof currentPath !== 'undefined' ? /^\/admin/.test(currentPath) : false); %>
  <% const isSuperAdmin = (typeof currentPath !== 'undefined' ? /^\/superadmin/.test(currentPath) : false); %>
  <% const isHomePage = (typeof currentPath !== 'undefined' ? currentPath === '/' : false); %>
  <%- include(isSuperAdmin ? '../partials/header-admin' : (isHomePage ? '../partials/header' : '../partials/header-main')) %>
  <main id="main-content" class="<%= (typeof useMainContainer !== 'undefined' && useMainContainer === false) ? '' : 'container' %> <%= (isAdmin || isSuperAdmin || !isHomePage) ? 'main-offset' : '' %>" role="main">
    <%- body %>
  </main>
  <% if (!(isAdmin || isSuperAdmin) && !(typeof hideFooter !== 'undefined' && hideFooter === true)) { %>
    <%- include('../partials/footer') %>
  <% } %>
  
  <!-- Christmas Popup -->
  <% if (getActiveTheme && getActiveTheme() === 'christmas') { %>
    <%
      const isLoggedIn = typeof user !== 'undefined' && user !== null;
      const currentTheme = getActiveTheme();
      const logoPath = (currentTheme === 'christmas') 
        ? '/images/Christmas%20assets/Logo%20-%20christmas.png' 
        : '/images/Sweet%20Home%20Logo.png';
    %>
    <div id="christmas-popup" class="christmas-popup" style="display: none;" data-is-logged-in="<%= isLoggedIn ? 'true' : 'false' %>">
      <div class="christmas-popup__overlay"></div>
      <div class="christmas-popup__content">
        <button class="christmas-popup__close" aria-label="Close popup">&times;</button>
        <div class="christmas-popup__logo">
          <img src="<%= logoPath %>" alt="Sweet Home" onerror="this.style.display='none'">
        </div>
        <h2 class="christmas-popup__main-message">We wish you a merry christmas and a happy 2026!</h2>
        <p class="christmas-popup__secondary-message">
          <% if (isLoggedIn) { %>
            We are extremely grateful for your work this year, and very excited to continue succeeding with you the next year!
          <% } else { %>
            This 2026 we will be here, ready to help you in your next real estate investment.
          <% } %>
        </p>
      </div>
    </div>
    <link rel="stylesheet" href="/css/christmas-popup.css?v=2">
    <script src="/js/christmas-popup.js" defer></script>
  <% } %>
</body>
</html>